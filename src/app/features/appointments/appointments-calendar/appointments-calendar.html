<div class="h-full flex flex-col">
    <!-- Header & Filters -->
    <div class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col gap-4">

        <!-- Top Row: Title & Actions -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-xl font-bold text-gray-900">Agenda de citas</h1>
                <p class="text-sm text-gray-500">Gestiona los turnos y citas médicas globales.</p>
            </div>

            <div class="flex items-center gap-3">
                <button (click)="openGenericBooking()"
                    class="flex items-center gap-2 bg-primary hover:bg-primary text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-primary transition-all active:scale-95 whitespace-nowrap">
                    <lucide-icon [img]="icons.Plus" class="w-5 h-5"></lucide-icon>
                    Nueva cita
                </button>
            </div>
        </div>

        <!-- Filters Row (Only Filters Here) -->
        <div class="flex flex-wrap items-center gap-3 w-full">
            <!-- Specialty Filter -->
            <div class="min-w-[250px] flex-1 md:flex-none">
                <app-searchable-select [options]="specialtyOptions" [ngModel]="selectedSpecialtyId()"
                    (ngModelChange)="selectedSpecialtyId.set($event.toString()); selectedDoctorId.set('')"
                    placeholder="Todas las especialidades" displayMode="compact">
                </app-searchable-select>
            </div>

            <!-- Doctor Filter -->
            <div class="min-w-[250px] flex-1 md:flex-none">
                <app-searchable-select [options]="doctorOptions" [ngModel]="selectedDoctorId()"
                    (ngModelChange)="selectedDoctorId.set($event.toString())" placeholder="Todos los médicos"
                    displayMode="compact">
                </app-searchable-select>
            </div>
        </div>
    </div>

    <!-- Calendar Grid Area -->
    <div class="flex-1 overflow-auto bg-gray-50 p-2 sm:p-6 flex flex-col">

        <!-- Unified Toolbar (Legend + Date Nav + View Toggle) -->
        <div
            class="flex flex-col xl:flex-row items-center justify-between gap-4 mb-4 bg-white p-2 rounded-xl border border-gray-200 shadow-sm">

            <!-- Left: Legend -->
            <div class="flex items-center gap-3 text-[10px] font-medium text-gray-500 px-2">
                <div class="flex items-center gap-1.5">
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div> Pagada
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div> Reservada
                </div>
                <div class="flex items-center gap-1.5">
                    <div class="w-2.5 h-2.5 rounded border border-primary border-dashed bg-primary"></div> Disponible
                </div>
            </div>

            <!-- Center: Date Navigation -->
            <div class="flex items-center bg-gray-50 rounded-lg p-1 border border-gray-100">
                <button (click)="changeWeek(-1)"
                    class="p-1.5 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-500 hover:text-gray-900">
                    <lucide-icon [img]="icons.ChevronLeft" class="w-4 h-4"></lucide-icon>
                </button>
                <div class="px-4 text-center min-w-[160px]">
                    <ng-container *ngIf="viewMode() === 'week'">
                        <span class="block text-xs font-bold text-gray-900 leading-none mb-0.5">
                            {{ weekDays()[0].dayNum }} {{ weekDays()[0].monthName }} - {{ weekDays()[6].dayNum }} {{
                            weekDays()[6].monthName }}
                        </span>
                        <span class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider">
                            {{ weekDays()[0].date.getFullYear() }}
                        </span>
                    </ng-container>
                    <ng-container *ngIf="viewMode() === 'day'">
                        <span class="block text-xs font-bold text-gray-900 capitalize leading-none">
                            {{ currentDateStr() | titlecase }}
                        </span>
                    </ng-container>
                </div>
                <button (click)="changeWeek(1)"
                    class="p-1.5 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-500 hover:text-gray-900">
                    <lucide-icon [img]="icons.ChevronRight" class="w-4 h-4"></lucide-icon>
                </button>
            </div>

            <!-- Right: View Toggle -->
            <div class="bg-gray-100 p-1 rounded-lg flex">
                <button (click)="toggleView('day')"
                    [class]="'px-3 py-1 text-xs font-bold rounded-md transition-all ' + (viewMode() === 'day' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-900')">
                    Día
                </button>
                <button (click)="toggleView('week')"
                    [class]="'px-3 py-1 text-xs font-bold rounded-md transition-all ' + (viewMode() === 'week' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-900')">
                    Semana
                </button>
            </div>
        </div>

        <!-- Weekly & Daily View Container -->
        <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden min-w-[800px]">

            <!-- Header Row -->
            <div class="grid border-b border-gray-200 bg-gray-50 sticky top-0 z-10"
                [class]="viewMode() === 'week' ? 'grid-cols-8' : 'grid-cols-[auto_1fr]'">

                <!-- Time Label Header -->
                <div
                    class="p-4 text-xs font-semibold text-gray-400 uppercase tracking-wider text-center border-r border-gray-200 w-20 flex items-center justify-center">
                    Hora
                </div>

                <!-- Week View Headers -->
                <ng-container *ngIf="viewMode() === 'week'">
                    <div *ngFor="let day of weekDays()"
                        class="p-4 text-center border-r border-gray-200 last:border-r-0">
                        <p class="text-xs font-semibold text-gray-500 uppercase mb-1">{{ day.dayName }}</p>
                        <div class="flex flex-col items-center leading-none">
                            <span class="text-lg font-bold text-gray-900">{{ day.dayNum }}</span>
                            <span class="text-[10px] font-bold text-gray-400 uppercase mt-0.5">{{ day.monthName
                                }}</span>
                        </div>
                    </div>
                </ng-container>

                <!-- Day View Header -->
                <ng-container *ngIf="viewMode() === 'day'">
                    <div class="p-4 text-center">
                        <p class="text-xs font-semibold text-gray-500 uppercase">{{ currentDateStr() }}</p>
                    </div>
                </ng-container>
            </div>

            <!-- Time Slots Body -->
            <div class="relative">
                <div *ngFor="let time of timeSlots()"
                    class="grid border-b border-gray-100 last:border-b-0 min-h-[3.5rem]"
                    [class]="(viewMode() === 'week' ? 'grid-cols-8' : 'grid-cols-[auto_1fr]') + (isBreakTime(time) ? ' bg-gray-100' : '')">

                    <!-- Time Label -->
                    <div
                        class="w-20 p-2 text-xs font-medium text-gray-500 text-center border-r border-gray-100 flex items-center justify-center bg-gray-50/50">
                        {{ time }}
                    </div>

                    <!-- Week View Columns -->
                    <ng-container *ngIf="viewMode() === 'week'">
                        <div *ngFor="let day of weekDays(); let i = index"
                            [class]="(!isWorkingDay(i) || isPastDate(day.iso) ? 'bg-gray-100/70 ' : '') + 'border-r border-gray-100 last:border-r-0 relative p-1 min-h-[3.5rem]'">

                            <!-- Logic to determine slot content -->
                            <ng-container *ngIf="getSlotStatus(day.iso, time, i) as items">

                                <!-- Unavailable BG -->
                                <div *ngIf="items.length === 0" class="absolute inset-0 bg-gray-50/50 -z-10"></div>

                                <!-- Items Loop -->
                                <div class="w-full h-full relative z-10"
                                    [ngClass]="items.length >= 3 ? 'flex flex-row flex-wrap content-start gap-1 p-1' : 'flex flex-col gap-1'">
                                    <ng-container *ngFor="let item of items">

                                        <!-- Available Card -->
                                        <button *ngIf="item.type === 'available'"
                                            (click)="!item.isPast && openBookingModal(day.iso, time, item.doctorId, item.specialtyId)"
                                            [disabled]="item.isPast"
                                            [ngClass]="(items.length >= 3 ? 'w-8 h-8 p-0 justify-center ' : 'w-full min-h-[30px] p-0.5 ') + 
                                                       (item.isPast ? 'opacity-100 cursor-not-allowed bg-gray-200 border-gray-300 border-dashed text-gray-500' : 'cursor-pointer hover:bg-primary hover:border-solid hover:shadow-md bg-primary border-primary border-dashed')"
                                            class="rounded border transition-all group flex flex-col justify-center items-center gap-0.5 relative">

                                            <!-- Normal View -->
                                            <ng-container *ngIf="items.length < 3">
                                                <span
                                                    [class]="item.isPast ? 'text-[9px] font-medium truncate w-full text-center' : 'text-[9px] font-medium text-primary truncate w-full text-center'">{{
                                                    item.doctorName }}</span>
                                                <span
                                                    class="text-[9px] text-primary opacity-80 truncate w-full text-center pb-0.5">{{
                                                    getSpecialtyName(item.specialtyId) }}</span>
                                            </ng-container>

                                            <!-- Condensed View (Icon) -->
                                            <lucide-icon *ngIf="items.length >= 3" [img]="icons.Plus"
                                                class="w-4 h-4 text-primary"></lucide-icon>

                                            <!-- Tooltip -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[150px] bg-gray-900 text-white text-[10px] rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg text-center">
                                                <div>{{ item.doctorName }}</div>
                                                <div class="opacity-75">{{ getSpecialtyName(item.specialtyId) }}</div>
                                            </div>
                                        </button>

                                        <!-- Booked Card -->
                                        <button *ngIf="item.type === 'booked'"
                                            (click)="openAppointmentDetails(item.appointment); $event.stopPropagation()"
                                            [ngClass]="items.length >= 3 ? 'w-8 h-8 p-0 justify-center items-center' : 'w-full min-h-[40px] p-1.5 text-left'"
                                            [class]="'rounded border-l-4 shadow-sm cursor-pointer hover:shadow-md transition-all relative group flex flex-col justify-center ' + getAppointmentColorClass(item.appointment)">

                                            <!-- Normal View -->
                                            <ng-container *ngIf="items.length < 3">
                                                <div class="font-bold text-[10px] truncate w-full">{{
                                                    getPatientName(item.appointment.patientId) }}</div>
                                                <div class="truncate text-[9px] opacity-80 w-full">{{
                                                    getSpecialtyName(item.appointment.specialtyId) }}</div>
                                            </ng-container>

                                            <!-- Condensed View -->
                                            <div *ngIf="items.length >= 3"
                                                class="w-full h-full flex items-center justify-center">
                                                <!-- Paid -> Check (Green) -->
                                                <lucide-icon *ngIf="item.appointment.paymentStatus === 'PAID'"
                                                    [img]="icons.CheckCircle"
                                                    class="w-4 h-4 text-green-600"></lucide-icon>

                                                <!-- Pending -> Help (Yellow) -->
                                                <lucide-icon
                                                    *ngIf="item.appointment.status === 'CONFIRMED' && item.appointment.paymentStatus === 'PENDING'"
                                                    [img]="icons.HelpCircle"
                                                    class="w-4 h-4 text-yellow-600"></lucide-icon>

                                                <!-- Default -> Initials -->
                                                <div *ngIf="!(item.appointment.paymentStatus === 'PAID') && !(item.appointment.status === 'CONFIRMED' && item.appointment.paymentStatus === 'PENDING')"
                                                    class="text-[9px] font-bold">
                                                    {{ getPatientName(item.appointment.patientId).charAt(0) }}
                                                </div>
                                            </div>

                                            <!-- Tooltip -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[150px] bg-gray-900 text-white text-[10px] rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg text-left">
                                                <div class="font-bold">{{ getPatientName(item.appointment.patientId) }}
                                                </div>
                                                <div>{{ getSpecialtyName(item.appointment.specialtyId) }}</div>
                                                <div class="opacity-75">{{ getAppointmentStatusLabel(item.appointment)
                                                    }}</div>
                                            </div>
                                        </button>

                                    </ng-container>
                                </div>
                            </ng-container>
                        </div>
                    </ng-container>

                    <!-- Day View Column -->
                    <ng-container *ngIf="viewMode() === 'day'">
                        <div class="relative p-2 bg-white">
                            <!-- Show Current Day (Today) -->
                            <!-- Reusing getSlotStatus logic with current date -->
                            <ng-container
                                *ngIf="getSlotStatus(currentDate().toISOString().split('T')[0], time, 0) as items">

                                <!-- Unavailable BG -->
                                <div *ngIf="items.length === 0"
                                    class="absolute inset-0 bg-gray-50/40 pattern-diagonal-lines"></div>

                                <!-- Cards Container (Horizontal layout for concurrent) -->
                                <div class="w-full h-full relative z-10"
                                    [ngClass]="items.length >= 3 ? 'flex flex-wrap content-start gap-1 p-1' : 'flex gap-2'">

                                    <ng-container *ngFor="let item of items">

                                        <!-- Available (Programado) -->
                                        <button *ngIf="item.type === 'available'"
                                            (click)="openBookingModal(currentDate().toISOString().split('T')[0], time, item.doctorId, item.specialtyId)"
                                            [ngClass]="items.length >= 3 ? 'w-8 h-8 p-0 justify-center' : 'flex-1 p-2 justify-between min-w-[140px]'"
                                            class="rounded-lg bg-primary border border-primary border-dashed hover:bg-primary hover:border-solid hover:shadow-md transition-all flex items-center gap-2 group/card cursor-pointer relative">

                                            <!-- Normal View Content -->
                                            <div *ngIf="items.length < 3" class="text-left overflow-hidden">
                                                <div
                                                    class="text-xs font-bold text-primary truncate group-hover/card:text-primary">
                                                    {{ item.doctorName }}</div>
                                                <div class="text-[10px] text-primary font-medium truncate">{{
                                                    getSpecialtyName(item.specialtyId) }}</div>
                                            </div>
                                            <div *ngIf="items.length < 3"
                                                class="w-6 h-6 rounded-full bg-primary flex items-center justify-center flex-shrink-0 group-hover/card:bg-primary transition-colors">
                                                <lucide-icon [img]="icons.Plus"
                                                    class="w-3 h-3 text-primary"></lucide-icon>
                                            </div>

                                            <!-- Condensed View Content (Icon Only) -->
                                            <lucide-icon *ngIf="items.length >= 3" [img]="icons.Plus"
                                                class="w-4 h-4 text-primary"></lucide-icon>

                                            <!-- Tooltip (Hover) -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[200px] bg-gray-900 text-white text-xs rounded px-2 py-1 opacity-0 group-hover/card:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg">
                                                <div>{{ item.doctorName }}</div>
                                                <div class="opacity-75">{{ getSpecialtyName(item.specialtyId) }}</div>
                                            </div>
                                        </button>

                                        <!-- Booked Card -->
                                        <div *ngIf="item.type === 'booked'"
                                            (click)="openAppointmentDetails(item.appointment)"
                                            [ngClass]="items.length >= 3 ? 'w-8 h-8 p-0 justify-center' : 'flex-1 p-2 min-w-[140px]'"
                                            [class]="'rounded-lg border-l-4 shadow-sm cursor-pointer hover:shadow hover:scale-[1.01] transition-all relative group/card flex items-center ' + getAppointmentColorClass(item.appointment)">

                                            <!-- Normal View Content -->
                                            <div *ngIf="items.length < 3" class="overflow-hidden w-full">
                                                <div class="font-bold text-xs truncate">{{
                                                    getPatientName(item.appointment.patientId) }}
                                                </div>
                                                <div class="text-[10px] opacity-90 truncate">{{
                                                    getSpecialtyName(item.appointment.specialtyId) }}</div>
                                            </div>

                                            <!-- Condensed View Content -->
                                            <div *ngIf="items.length >= 3"
                                                class="w-full h-full flex items-center justify-center">
                                                <!-- Paid -> Check (Green) -->
                                                <lucide-icon *ngIf="item.appointment.paymentStatus === 'PAID'"
                                                    [img]="icons.CheckCircle"
                                                    class="w-4 h-4 text-green-600"></lucide-icon>

                                                <!-- Pending -> Help (Yellow) -->
                                                <lucide-icon
                                                    *ngIf="item.appointment.status === 'CONFIRMED' && item.appointment.paymentStatus === 'PENDING'"
                                                    [img]="icons.HelpCircle"
                                                    class="w-4 h-4 text-yellow-600"></lucide-icon>

                                                <!-- Default -> Initials -->
                                                <div *ngIf="!(item.appointment.paymentStatus === 'PAID') && !(item.appointment.status === 'CONFIRMED' && item.appointment.paymentStatus === 'PENDING')"
                                                    class="text-[10px] font-bold text-center">
                                                    {{ getPatientName(item.appointment.patientId).charAt(0) }}
                                                </div>
                                            </div>

                                            <!-- Tooltip -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[200px] bg-gray-900 text-white text-xs rounded px-2 py-1 opacity-0 group-hover/card:opacity-100 transition-opacity pointer-events-none z-50 shadow-lg text-left">
                                                <div class="font-bold">{{ getPatientName(item.appointment.patientId) }}
                                                </div>
                                                <div>{{ getSpecialtyName(item.appointment.specialtyId) }}</div>
                                                <div class="opacity-75">{{ getAppointmentStatusLabel(item.appointment)
                                                    }}
                                                </div>
                                            </div>
                                        </div>

                                    </ng-container>
                                </div>

                            </ng-container>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generic Booking Modal -->
<div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6">
    <!-- Backdrop with click to close -->
    <div class="absolute inset-0 bg-black bg-opacity-60 transition-opacity backdrop-blur-sm"
        (click)="tryCloseBookingModal()"></div>

    <!-- Modal Content -->
    <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col relative z-10 overflow-hidden animate-fade-in-up">
        <!-- Modal Header (Fixed) -->
        <div class="bg-primary px-6 py-4 shrink-0 flex items-center justify-between shadow-md z-20">
            <div>
                <h2 class="text-xl font-bold text-white">Agendar nueva cita</h2>
                <p class="text-primary text-sm">Selecciona los detalles de tu consulta</p>
            </div>
            <button (click)="tryCloseBookingModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-all">
                <lucide-icon [img]="icons.Plus" class="w-6 h-6 rotate-45"></lucide-icon>
            </button>
        </div>

        <!-- Modal Body (Scrollable) -->
        <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Form Details -->
                <div class="space-y-5">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2">Detalles</h3>
                        <p class="text-xs text-gray-500">Completa la información requerida</p>
                    </div>

                    <!-- Specialty -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Especialidad <span class="text-red-500">*</span>
                        </label>
                        <app-searchable-select [options]="modalSpecialtyOptions" [ngModel]="modalSpecialtyId()"
                            (ngModelChange)="modalSpecialtyId.set($event.toString()); modalDoctorId.set('')"
                            placeholder="Seleccionar especialidad" displayMode="default">
                        </app-searchable-select>
                    </div>

                    <!-- Doctor -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Médico <span class="text-red-500">*</span>
                        </label>
                        <app-searchable-select [options]="modalDoctorOptions" [ngModel]="modalDoctorId()"
                            (ngModelChange)="modalDoctorId.set($event.toString())" [disabled]="!modalSpecialtyId()"
                            placeholder="Seleccionar médico" displayMode="default">
                        </app-searchable-select>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Fecha <span class="text-red-500">*</span>
                        </label>
                        <input type="date" [ngModel]="modalDate()" (ngModelChange)="modalDate.set($event)"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-primary focus:ring-2 focus:ring-primary transition-all outline-none">
                    </div>

                    <!-- Patient -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Paciente <span class="text-red-500">*</span>
                        </label>
                        <app-searchable-select [options]="modalPatientOptions" [ngModel]="modalPatientId()"
                            (ngModelChange)="modalPatientId.set($event.toString())" placeholder="Seleccionar paciente"
                            displayMode="default">
                        </app-searchable-select>
                    </div>
                </div>

                <!-- Right Column: Time Slots -->
                <div
                    class="bg-gradient-to-br from-gray-50 to-primary rounded-2xl p-6 border-2 border-gray-100 flex flex-col h-full min-h-[300px]">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2 text-center">
                        Horarios disponibles
                    </h3>

                    <div *ngIf="availableSlotsForModal().length > 0"
                        class="flex-1 grid grid-cols-3 gap-3 content-start overflow-y-auto pr-1 custom-scrollbar max-h-[300px]">
                        <button *ngFor="let slot of availableSlotsForModal()" (click)="modalTime.set(slot)"
                            [class]="'py-2 px-1 h-10 flex items-center justify-center text-sm font-bold rounded-xl border-2 transition-all duration-200 ' + 
                                (modalTime() === slot 
                                    ? 'bg-primary border-primary text-white shadow-lg shadow-primary scale-105' 
                                    : 'bg-white border-gray-200 text-gray-700 hover:border-primary hover:shadow-md hover:scale-102')">
                            {{ slot }}
                        </button>
                    </div>

                    <div *ngIf="availableSlotsForModal().length === 0"
                        class="flex-1 flex flex-col items-center justify-center text-center text-gray-400">
                        <lucide-icon [img]="icons.Clock" class="w-12 h-12 mb-3 opacity-20"></lucide-icon>
                        <p class="text-sm font-medium px-4 leading-relaxed">
                            {{ !modalDoctorId() || !modalDate() ? 'Selecciona médico y fecha para ver horarios.' : 'No
                            hay horarios disponibles para esta fecha.' }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payment Method & Notes -->
            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-4">Información Adicional</h3>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                    <button type="button" (click)="modalPaymentMethod.set('CASH')"
                        [class]="'flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'CASH' ? 'border-primary bg-primary' : 'border-gray-200 bg-white hover:border-gray-300')">
                        <span class="text-xs font-bold"
                            [class.text-primary]="modalPaymentMethod() === 'CASH'">Efectivo</span>
                    </button>
                    <button type="button" (click)="modalPaymentMethod.set('YAPE')"
                        [class]="'flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'YAPE' ? 'border-primary bg-primary' : 'border-gray-200 bg-white hover:border-gray-300')">
                        <span class="text-xs font-bold"
                            [class.text-primary]="modalPaymentMethod() === 'YAPE'">Yape</span>
                    </button>
                    <button type="button" (click)="modalPaymentMethod.set('PLIN')"
                        [class]="'flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'PLIN' ? 'border-primary bg-primary' : 'border-gray-200 bg-white hover:border-gray-300')">
                        <span class="text-xs font-bold"
                            [class.text-primary]="modalPaymentMethod() === 'PLIN'">Plin</span>
                    </button>
                    <button type="button" (click)="modalPaymentMethod.set('CARD')"
                        [class]="'flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'CARD' ? 'border-primary bg-primary' : 'border-gray-200 bg-white hover:border-gray-300')">
                        <span class="text-xs font-bold"
                            [class.text-primary]="modalPaymentMethod() === 'CARD'">Tarjeta</span>
                    </button>
                </div>

                <div *ngIf="['YAPE', 'PLIN'].includes(modalPaymentMethod())" class="mb-6 animate-fade-in">
                    <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                        Comprobante de Pago (URL)
                    </label>
                    <input type="text" [ngModel]="modalPaymentProof()" (ngModelChange)="modalPaymentProof.set($event)"
                        placeholder="Pegar enlace de la imagen..."
                        class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm focus:border-primary focus:ring-2 focus:ring-primary transition-all outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">Notas</label>
                    <textarea [ngModel]="modalNotes()" (ngModelChange)="modalNotes.set($event)"
                        placeholder="Observaciones..." rows="2"
                        class="w-full rounded-xl border-2 border-gray-200 py-2 px-4 text-sm focus:border-primary outline-none resize-none"></textarea>
                </div>
            </div>
        </div>

        <!-- Modal Footer (Fixed) -->
        <div class="bg-gray-50 px-6 py-4 flex gap-3 border-t border-gray-200 shrink-0">
            <button (click)="tryCloseBookingModal()" type="button" [disabled]="saving()"
                class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition-all">
                Cancelar
            </button>
            <button (click)="saveAppointment()"
                [disabled]="saving() || !modalPatientId() || !modalTime() || !modalDoctorId()" type="button"
                class="flex-1 py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary hover:bg-primary transition-all disabled:opacity-50 disabled:shadow-none">
                <span *ngIf="!saving()">Confirmar Cita</span>
                <span *ngIf="saving()">Guardando...</span>
            </button>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div *ngIf="isDetailsModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6">
    <!-- Backdrop with click to close -->
    <div class="absolute inset-0 bg-black bg-opacity-60 transition-opacity backdrop-blur-sm"
        (click)="tryCloseDetailsModal()"></div>

    <!-- Modal Content -->
    <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative z-10 overflow-hidden animate-fade-in-up">

        <!-- Header (Fixed) -->
        <div
            [class]="getDetailsHeaderClass() + ' px-6 py-4 shrink-0 flex items-center justify-between shadow-md z-20 transition-colors duration-300'">
            <div>
                <h2 class="text-xl font-bold text-white">Detalles de la cita</h2>
                <p class="text-white text-opacity-90 text-sm">Información completa</p>
            </div>
            <button (click)="tryCloseDetailsModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-all">
                <lucide-icon [img]="icons.Plus" class="w-6 h-6 rotate-45"></lucide-icon>
            </button>
        </div>

        <!-- Body (Scrollable) -->
        <div class="p-6 overflow-y-auto custom-scrollbar flex-1 bg-white">

            <!-- Standard View -->
            <div *ngIf="selectedAppointment && !isRescheduling && !isConfirmingCancel" class="space-y-6">

                <!-- Patient Info Header -->
                <div class="bg-primary rounded-xl p-4 border border-primary flex items-center gap-4">
                    <div class="bg-white p-2 rounded-full shadow-sm text-primary">
                        <lucide-icon [img]="icons.User" class="w-6 h-6"></lucide-icon>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 leading-tight">{{
                            getPatientName(selectedAppointment.patientId) }}</h3>
                        <p class="text-sm text-primary font-medium">Paciente</p>
                    </div>
                </div>

                <!-- Fields Grid -->
                <div class="grid grid-cols-2 gap-x-8 gap-y-6">
                    <!-- Group 1 -->
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Médico</label>
                        <p class="text-sm font-bold text-gray-800">{{ getDoctorName(selectedAppointment.doctorId) }}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Especialidad</label>
                        <p class="text-sm font-bold text-gray-800">{{ getSpecialtyName(selectedAppointment.specialtyId)
                            }}</p>
                    </div>

                    <!-- Divider -->
                    <div class="col-span-2 border-t border-gray-100"></div>

                    <!-- Group 2 -->
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Fecha</label>
                        <p class="text-sm font-bold text-gray-800 capitalize">{{
                            formatDate(selectedAppointment.appointmentDate) }}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Horario</label>
                        <p class="text-sm font-bold text-gray-800">
                            {{ formatTime12Hour(selectedAppointment.startTime) }} - {{
                            formatTime12Hour(selectedAppointment.endTime) }}
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Estado</label>
                        <span
                            [class]="'px-2 py-1 rounded text-xs font-bold ' + getAppointmentColorClass(selectedAppointment)">
                            {{ getAppointmentStatusLabel(selectedAppointment) }}
                        </span>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Pago</label>
                        <p class="text-sm font-bold text-gray-800">{{ selectedAppointment.paymentMethod }}</p>
                    </div>
                </div>

                <!-- Payment Validation Action -->
                <div *ngIf="selectedAppointment.paymentStatus !== 'PAID'" class="mb-6 animate-fade-in">
                    <button (click)="validatePayment()"
                        class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-md transition-all flex items-center justify-center gap-2">
                        <lucide-icon [img]="icons.CheckCircle" class="w-5 h-5"></lucide-icon>
                        Confirmar Pago Realizado
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-2">
                        Esta acción marcará la cita como <strong>Pagada</strong> y <strong>Confirmada</strong>.
                    </p>
                </div>

                <!-- Payment Proof (Only if exists) -->
                <div *ngIf="selectedAppointment.paymentProofUrl"
                    class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Comprobante de Pago</label>
                    <div class="relative group cursor-pointer overflow-hidden rounded-lg border border-gray-200">
                        <img [src]="selectedAppointment.paymentProofUrl" alt="Comprobante"
                            class="w-full h-auto max-h-[200px] object-cover hover:scale-105 transition-transform">
                        <a [href]="selectedAppointment.paymentProofUrl" target="_blank"
                            class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity z-10 w-full h-full">
                            <span class="text-white text-xs font-bold flex items-center gap-2">
                                <lucide-icon [img]="icons.Search" class="w-4 h-4"></lucide-icon> Ver completo
                            </span>
                        </a>
                    </div>
                </div>

                <!-- Notes -->
                <div *ngIf="selectedAppointment.notes" class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Notas</label>
                    <p class="text-sm text-gray-600 italic">"{{ selectedAppointment.notes }}"</p>
                </div>
            </div>

            <!-- Rescheduling View -->
            <div *ngIf="isRescheduling" class="space-y-6">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <p class="text-sm text-yellow-800 font-medium">
                        Reprogramando cita. Selecciona una nueva fecha o médico.
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Fecha</label>
                        <input type="date" [ngModel]="modalDate()" (ngModelChange)="modalDate.set($event)"
                            class="w-full rounded-xl border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Especialidad</label>
                            <div class="w-full py-2 px-3 bg-gray-100 rounded-lg text-gray-500 text-sm font-bold">{{
                                getSpecialtyName(modalSpecialtyId()) }}</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Médico</label>
                            <app-searchable-select [options]="modalDoctorOptions" [ngModel]="modalDoctorId()"
                                (ngModelChange)="modalDoctorId.set($event.toString())" placeholder="Seleccionar médico"
                                displayMode="default">
                            </app-searchable-select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Horario</label>
                        <div class="grid grid-cols-4 gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                            <button *ngFor="let slot of availableSlotsForModal()" (click)="modalTime.set(slot)"
                                [class]="'py-2 text-xs font-bold rounded-lg border transition-all ' + 
                                (modalTime() === slot ? 'bg-primary text-white border-primary' : 'bg-white text-gray-700 border-gray-200 hover:border-primary')">
                                {{ slot }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancel Confirmation -->
            <div *ngIf="isConfirmingCancel" class="text-center py-8">
                <div
                    class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <lucide-icon [img]="icons.AlertCircle" class="w-8 h-8"></lucide-icon>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">¿Seguro que deseas cancelar?</h3>
                <p class="text-gray-600 text-sm mb-8 px-8">La cita de se eliminará permanentemente de la agenda.</p>
                <div class="flex gap-4">
                    <button (click)="cancelCancelConfirmation()"
                        class="flex-1 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">Volver</button>
                    <button (click)="confirmCancel()"
                        class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-lg shadow-red-200">Confirmar</button>
                </div>
            </div>

        </div>

        <!-- Footer (Fixed) -->
        <div *ngIf="!isConfirmingCancel"
            class="bg-gray-50 px-6 py-4 flex flex-col-reverse sm:flex-row gap-3 border-t border-gray-200 shrink-0">
            <button (click)="tryCloseDetailsModal()"
                class="flex-1 py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50">
                Cerrar
            </button>

            <div class="flex flex-1 gap-2">
                <button *ngIf="!isRescheduling && selectedAppointment?.status !== 'CANCELLED'"
                    (click)="showCancelConfirmation()"
                    class="flex-1 py-3 bg-red-100 text-red-700 font-bold rounded-xl hover:bg-red-200">
                    Cancelar
                </button>
                <button *ngIf="!isRescheduling && selectedAppointment?.status !== 'CANCELLED'"
                    (click)="startRescheduling()"
                    class="flex-1 py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary hover:bg-primary">
                    Reprogramar
                </button>
                <button *ngIf="isRescheduling" (click)="saveRescheduledAppointment()" [disabled]="!modalTime()"
                    class="flex-1 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200 hover:bg-green-700 disabled:opacity-50">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>