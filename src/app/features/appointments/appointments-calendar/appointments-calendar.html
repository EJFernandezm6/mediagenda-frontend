<div class="h-full flex flex-col">
    <!-- Header & Filters -->
    <div
        class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Agenda de Citas</h1>
            <p class="text-sm text-gray-500">Gestiona los turnos y citas médicas globales.</p>
        </div>

        <!-- Action & Navigation -->
        <div class="flex items-center gap-4">
            <button (click)="openGenericBooking()"
                class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                <lucide-icon [img]="icons.Plus" class="w-5 h-5"></lucide-icon>
                Agendar Nueva Cita
            </button>

            <!-- Date Navigation (For Calendar View if needed, or just context) -->
            <div class="flex items-center bg-gray-100 rounded-xl p-1">
                <button (click)="changeWeek(-1)"
                    class="p-1.5 hover:bg-white hover:shadow-sm rounded-lg transition-all text-gray-600">
                    <lucide-icon [img]="icons.ChevronLeft" class="w-5 h-5"></lucide-icon>
                </button>
                <span class="px-4 text-xs font-bold text-gray-900 min-w-[140px] text-center uppercase tracking-wide">
                    {{ weekDays()[0].dayName }} {{ weekDays()[0].dayNum }} - {{ weekDays()[6].dayName }} {{
                    weekDays()[6].dayNum }}
                </span>
                <button (click)="changeWeek(1)"
                    class="p-1.5 hover:bg-white hover:shadow-sm rounded-lg transition-all text-gray-600">
                    <lucide-icon [img]="icons.ChevronRight" class="w-5 h-5"></lucide-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Grid / Global View -->
    <div class="flex-1 overflow-auto bg-gray-50 p-6">

        <!-- Global View (No filters) -->
        <div *ngIf="!selectedDoctorId() || !selectedSpecialtyId()" class="space-y-6">
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-6 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-blue-900">Vista General del Día</h2>
                    <p class="text-sm text-blue-700">Visualizando todas las citas programadas para hoy across todos los
                        médicos.</p>
                </div>
                <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm">
                    <lucide-icon [img]="icons.Calendar" class="w-5 h-5 text-blue-600"></lucide-icon>
                    <span class="font-bold text-gray-900">{{ currentDateStr() }}</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Hora</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Paciente</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Médico</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase text-right">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr *ngFor="let app of globalAppointments()" class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <lucide-icon [img]="icons.Clock" class="w-4 h-4 text-gray-400"></lucide-icon>
                                    <span class="text-sm font-medium text-gray-900">{{ app.startTime }} - {{ app.endTime
                                        }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-gray-900">{{ app.patientName }}</span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {{ getDoctorName(app.doctorId) }}
                            </td>
                            <td class="px-6 py-4">
                                <span
                                    [class]="'px-2 py-1 rounded-full text-[10px] font-bold ' + 
                                    (app.status === 'CONFIRMED' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700')">
                                    {{ app.status }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button (click)="openAppointmentDetails(app)"
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline">
                                    Ver Detalles
                                </button>
                            </td>
                        </tr>
                        <tr *ngIf="globalAppointments().length === 0">
                            <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                                <lucide-icon [img]="icons.AlertCircle"
                                    class="w-12 h-12 mx-auto mb-2 opacity-20"></lucide-icon>
                                <p>No hay citas programadas para hoy.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Filtered Calendar View -->
        <div *ngIf="selectedDoctorId() && selectedSpecialtyId()"
            class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden min-w-[800px]">
            <!-- Header Row -->
            <div class="grid grid-cols-8 border-b border-gray-200 bg-gray-50">
                <div
                    class="p-4 text-xs font-semibold text-gray-400 uppercase tracking-wider text-center border-r border-gray-200">
                    Hora</div>
                <div *ngFor="let day of weekDays()" class="p-4 text-center border-r border-gray-200 last:border-r-0">
                    <p class="text-xs font-semibold text-gray-500 uppercase">{{ day.dayName }}</p>
                    <p class="text-lg font-bold text-gray-900">{{ day.dayNum }}</p>
                </div>
            </div>

            <!-- Time Slots -->
            <div *ngFor="let time of timeSlots" class="grid grid-cols-8 border-b border-gray-100 last:border-b-0 h-20">
                <!-- Time Label -->
                <div
                    class="p-2 text-xs font-medium text-gray-500 text-center border-r border-gray-100 flex items-center justify-center bg-gray-50/50">
                    {{ time }}
                </div>

                <!-- Days Columns -->
                <div *ngFor="let day of weekDays(); let i = index"
                    class="border-r border-gray-100 last:border-r-0 relative group p-1">
                    <!-- Logic to determine slot content -->
                    <ng-container [ngSwitch]="getSlotStatus(day.iso, time, i)">

                        <!-- Booker -->
                        <button *ngSwitchCase="'available'" (click)="openBookingModal(day.iso, time)"
                            class="w-full h-full rounded-lg border-2 border-dashed border-gray-200 hover:border-blue-400 hover:bg-blue-50 flex items-center justify-center opacity-30 group-hover:opacity-100 transition-all text-blue-600">
                            <lucide-icon [img]="icons.Plus" class="w-5 h-5"></lucide-icon>
                        </button>

                        <!-- Appointment Card -->
                        <div *ngSwitchCase="'booked'"
                            class="w-full h-full bg-blue-100 border-l-4 border-blue-600 rounded p-2 overflow-hidden hover:shadow-md transition-shadow cursor-pointer">
                            <p class="text-xs font-bold text-blue-800 truncate">{{ getAppointment(day.iso,
                                time)?.patientName }}</p>
                            <p class="text-[10px] text-blue-600 truncate mt-0.5">{{ getAppointment(day.iso,
                                time)?.status }}</p>
                        </div>

                        <!-- Unavailable (Blank) -->
                        <div *ngSwitchDefault class="w-full h-full bg-gray-50/30"></div>

                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div *ngIf="isModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-white">Agendar Nueva Cita</h2>
                    <p class="text-blue-100 text-sm mt-1">Selecciona los detalles de tu consulta</p>
                </div>
                <button (click)="closeModal()"
                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all">
                    <lucide-icon [img]="icons.AlertCircle" class="w-6 h-6 rotate-45"></lucide-icon>
                </button>
            </div>
        </div>

        <!-- Modal Body -->
        <div class="p-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Column: Form Details -->
                <div class="space-y-5">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-4">Detalles de la
                            Cita</h3>
                        <p class="text-xs text-gray-500 mb-4">Selecciona los detalles de tu consulta</p>
                    </div>

                    <!-- Specialty -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Especialidad
                        </label>
                        <select [ngModel]="modalSpecialtyId()"
                            (ngModelChange)="modalSpecialtyId.set($event); modalDoctorId.set('')"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none">
                            <option value="" disabled>Seleccionar Especialidad</option>
                            <option *ngFor="let s of specialties()" [value]="s.id">{{ s.name }}</option>
                        </select>
                    </div>

                    <!-- Doctor -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Médico
                        </label>
                        <select [ngModel]="modalDoctorId()" (ngModelChange)="modalDoctorId.set($event)"
                            [disabled]="!modalSpecialtyId()"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none disabled:bg-gray-50 disabled:text-gray-400">
                            <option value="" disabled>Seleccionar Médico</option>
                            <option *ngFor="let d of filteredDoctorsForModal()" [value]="d.id">{{ d.fullName }}
                            </option>
                        </select>
                    </div>

                    <!-- Date -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Fecha
                        </label>
                        <input type="date" [ngModel]="modalDate()" (ngModelChange)="modalDate.set($event)"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none">
                    </div>

                    <!-- Patient -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                            Seleccionar Paciente
                        </label>
                        <select [ngModel]="modalPatientId()" (ngModelChange)="modalPatientId.set($event)"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none">
                            <option value="" disabled>Seleccionar Paciente</option>
                            <option *ngFor="let p of patients()" [value]="p.id">{{ p.fullName }} ({{ p.dni }})
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Right Column: Time Slots -->
                <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-6 border-2 border-gray-100">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-2 text-center">
                        Horarios Disponibles
                    </h3>
                    <p class="text-xs text-gray-500 mb-4 text-center">Elige una hora disponible</p>

                    <div *ngIf="availableSlotsForModal().length > 0"
                        class="grid grid-cols-3 gap-3 max-h-[320px] overflow-y-auto pr-2 custom-scrollbar">
                        <button *ngFor="let slot of availableSlotsForModal()" (click)="modalTime.set(slot)"
                            [class]="'py-3 px-2 text-sm font-bold rounded-xl border-2 transition-all duration-200 ' + 
                                (modalTime() === slot 
                                    ? 'bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-200 scale-105' 
                                    : 'bg-white border-gray-200 text-gray-700 hover:border-blue-400 hover:shadow-md hover:scale-102')">
                            {{ slot }}
                        </button>
                    </div>

                    <div *ngIf="availableSlotsForModal().length === 0"
                        class="h-[320px] flex flex-col items-center justify-center text-center text-gray-400">
                        <lucide-icon [img]="icons.Clock" class="w-16 h-16 mb-4 opacity-20"></lucide-icon>
                        <p class="text-sm font-medium px-6">Selecciona médico y fecha para ver disponibilidad
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payment Method & Notes -->
            <div class="mt-8 pt-8 border-t-2 border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-5">Método de Pago</h3>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <button type="button" (click)="modalPaymentMethod.set('CASH')" [class]="'relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'CASH' 
                                ? 'border-blue-600 bg-blue-50 shadow-md' 
                                : 'border-gray-200 bg-white hover:border-blue-300')">
                        <lucide-icon [img]="icons.User" class="w-6 h-6 mb-2"
                            [class]="modalPaymentMethod() === 'CASH' ? 'text-blue-600' : 'text-gray-400'"></lucide-icon>
                        <span
                            [class]="'text-xs font-bold ' + (modalPaymentMethod() === 'CASH' ? 'text-blue-600' : 'text-gray-600')">
                            Efectivo
                        </span>
                        <span class="text-xs text-gray-500 mt-1">En clínica</span>
                    </button>

                    <button type="button" (click)="modalPaymentMethod.set('YAPE')" [class]="'relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'YAPE' 
                                ? 'border-blue-600 bg-blue-50 shadow-md' 
                                : 'border-gray-200 bg-white hover:border-blue-300')">
                        <lucide-icon [img]="icons.User" class="w-6 h-6 mb-2"
                            [class]="modalPaymentMethod() === 'YAPE' ? 'text-blue-600' : 'text-gray-400'"></lucide-icon>
                        <span
                            [class]="'text-xs font-bold ' + (modalPaymentMethod() === 'YAPE' ? 'text-blue-600' : 'text-gray-600')">
                            Yape
                        </span>
                    </button>

                    <button type="button" (click)="modalPaymentMethod.set('PLIN')" [class]="'relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'PLIN' 
                                ? 'border-blue-600 bg-blue-50 shadow-md' 
                                : 'border-gray-200 bg-white hover:border-blue-300')">
                        <lucide-icon [img]="icons.User" class="w-6 h-6 mb-2"
                            [class]="modalPaymentMethod() === 'PLIN' ? 'text-blue-600' : 'text-gray-400'"></lucide-icon>
                        <span
                            [class]="'text-xs font-bold ' + (modalPaymentMethod() === 'PLIN' ? 'text-blue-600' : 'text-gray-600')">
                            Plin
                        </span>
                    </button>

                    <button type="button" (click)="modalPaymentMethod.set('CARD')" [class]="'relative flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all ' + 
                            (modalPaymentMethod() === 'CARD' 
                                ? 'border-blue-600 bg-blue-50 shadow-md' 
                                : 'border-gray-200 bg-white hover:border-blue-300')">
                        <lucide-icon [img]="icons.User" class="w-6 h-6 mb-2"
                            [class]="modalPaymentMethod() === 'CARD' ? 'text-blue-600' : 'text-gray-400'"></lucide-icon>
                        <span
                            [class]="'text-xs font-bold ' + (modalPaymentMethod() === 'CARD' ? 'text-blue-600' : 'text-gray-600')">
                            Tarjeta
                        </span>
                    </button>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">
                        Notas Adicionales
                    </label>
                    <textarea [ngModel]="modalNotes()" (ngModelChange)="modalNotes.set($event)"
                        placeholder="Escribe cualquier nota relevante para el médico..." rows="3"
                        class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none resize-none"></textarea>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div
            class="bg-gray-50 px-8 py-5 flex flex-col-reverse sm:flex-row gap-3 border-t-2 border-gray-100 rounded-b-2xl">
            <button (click)="closeModal()" type="button"
                class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 rounded-xl bg-white border-2 border-gray-300 px-6 py-3 text-sm font-bold text-gray-700 hover:bg-gray-50 transition-all">
                <lucide-icon [img]="icons.AlertCircle" class="w-5 h-5 rotate-45"></lucide-icon>
                Cancelar
            </button>
            <button (click)="saveAppointment()" [disabled]="!modalPatientId() || !modalTime() || !modalDoctorId()"
                type="button"
                class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-8 py-3 text-sm font-bold text-white shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none">
                <lucide-icon [img]="icons.CheckCircle" class="w-5 h-5"></lucide-icon>
                Confirmar Cita
            </button>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div *ngIf="isDetailsModalOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-700 px-8 py-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-white">Detalles de la Cita</h2>
                    <p class="text-indigo-100 text-sm mt-1">Información completa de la consulta</p>
                </div>
                <button (click)="closeDetailsModal()"
                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-all">
                    <lucide-icon [img]="icons.AlertCircle" class="w-6 h-6 rotate-45"></lucide-icon>
                </button>
            </div>
        </div>

        <!-- Modal Body - Details View -->
        <div class="p-8" *ngIf="selectedAppointment && !isRescheduling && !isConfirmingCancel">
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border-2 border-blue-100">
                <div class="flex items-center gap-3">
                    <lucide-icon [img]="icons.User" class="w-8 h-8 text-blue-600"></lucide-icon>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">{{ selectedAppointment.patientName }}</h3>
                        <p class="text-sm text-gray-600">Paciente</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Médico</label>
                    <p class="text-sm font-medium text-gray-900">{{ getDoctorName(selectedAppointment.doctorId) }}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Especialidad</label>
                    <p class="text-sm font-medium text-gray-900">{{ getSpecialtyName(selectedAppointment.specialtyId) }}
                    </p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Fecha</label>
                    <p class="text-sm font-medium text-gray-900">{{ selectedAppointment.date }}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Horario</label>
                    <p class="text-sm font-medium text-gray-900">{{ selectedAppointment.startTime }} - {{
                        selectedAppointment.endTime }}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Estado</label>
                    <span [class]="'inline-block px-3 py-1 rounded-full text-xs font-bold ' + 
                        (selectedAppointment.status === 'CONFIRMED' ? 'bg-green-100 text-green-700' : 
                         selectedAppointment.status === 'COMPLETED' ? 'bg-blue-100 text-blue-700' :
                         selectedAppointment.status === 'CANCELLED' ? 'bg-red-100 text-red-700' :
                         'bg-yellow-100 text-yellow-700')">
                        {{ selectedAppointment.status }}
                    </span>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Método de Pago</label>
                    <p class="text-sm font-medium text-gray-900">{{ selectedAppointment.paymentMethod || 'N/A' }}</p>
                </div>
            </div>

            <div *ngIf="selectedAppointment.notes" class="bg-gray-50 rounded-xl p-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Notas</label>
                <p class="text-sm text-gray-700">{{ selectedAppointment.notes }}</p>
            </div>
        </div>

        <!-- Modal Body - Rescheduling View -->
        <div class="p-8" *ngIf="isRescheduling">
            <div class="space-y-5">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <p class="text-sm text-yellow-700 italic">
                        Solo puedes cambiar el médico y el horario para esta especialidad.
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">Especialidad</label>
                        <div
                            class="w-full rounded-xl border-2 border-gray-100 bg-gray-50 py-3 px-4 text-sm font-bold text-gray-500 italic">
                            {{ getSpecialtyName(modalSpecialtyId()) }}
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">Médico</label>
                        <select [ngModel]="modalDoctorId()" (ngModelChange)="modalDoctorId.set($event)"
                            class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 outline-none transition-all">
                            <option *ngFor="let doctor of doctorsInCurrentSpecialty()" [value]="doctor.id">
                                {{ doctor.fullName }}
                            </option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">Nueva
                        Fecha</label>
                    <input type="date" [ngModel]="modalDate()" (ngModelChange)="modalDate.set($event)"
                        class="w-full rounded-xl border-2 border-gray-200 py-3 px-4 text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-2">Nuevo
                        Horario</label>
                    <div class="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        <button *ngFor="let slot of availableSlotsForModal()" (click)="modalTime.set(slot)" [class]="'py-2 px-2 text-sm font-bold rounded-lg border-2 transition-all ' + 
                            (modalTime() === slot 
                                ? 'bg-blue-600 border-blue-600 text-white' 
                                : 'bg-white border-gray-200 text-gray-700 hover:border-blue-400')">
                            {{ slot }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Body - Confirmation Cancel View -->
        <div class="p-12 text-center" *ngIf="isConfirmingCancel">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <lucide-icon [img]="icons.AlertCircle" class="w-10 h-10 text-red-600"></lucide-icon>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-2">¿Confirmar Cancelación?</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                ¿Estás seguro de que deseas cancelar la cita de **{{ selectedAppointment?.patientName }}**? Esta acción
                no se puede deshacer.
            </p>
            <div class="flex gap-4">
                <button (click)="cancelCancelConfirmation()"
                    class="flex-1 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all">
                    No, mantener cita
                </button>
                <button (click)="confirmCancel()"
                    class="flex-1 py-4 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-all shadow-lg shadow-red-200">
                    Sí, cancelar cita
                </button>
            </div>
        </div>

        <!-- Modal Footer -->
        <div *ngIf="!isConfirmingCancel"
            class="bg-gray-50 px-8 py-5 flex flex-col-reverse sm:flex-row gap-3 border-t-2 border-gray-100 rounded-b-2xl">
            <button (click)="closeDetailsModal()" type="button"
                class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 rounded-xl bg-white border-2 border-gray-300 px-6 py-3 text-sm font-bold text-gray-700 hover:bg-gray-50 transition-all">
                Cerrar
            </button>
            <div class="flex-1 flex gap-3">
                <button *ngIf="!isRescheduling && selectedAppointment?.status !== 'CANCELLED'"
                    (click)="showCancelConfirmation()" type="button"
                    class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-red-600 px-6 py-3 text-sm font-bold text-white hover:bg-red-700 transition-all">
                    <lucide-icon [img]="icons.AlertCircle" class="w-5 h-5"></lucide-icon>
                    Cancelar Cita
                </button>
                <button *ngIf="!isRescheduling && selectedAppointment?.status !== 'CANCELLED'"
                    (click)="startRescheduling()" type="button"
                    class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-600 px-6 py-3 text-sm font-bold text-white shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all">
                    <lucide-icon [img]="icons.Calendar" class="w-5 h-5"></lucide-icon>
                    Reprogramar
                </button>
                <button *ngIf="isRescheduling" (click)="saveRescheduledAppointment()"
                    [disabled]="!modalTime() || !modalDate() || !modalDoctorId()" type="button"
                    class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-8 py-3 text-sm font-bold text-white shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <lucide-icon [img]="icons.CheckCircle" class="w-5 h-5"></lucide-icon>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>