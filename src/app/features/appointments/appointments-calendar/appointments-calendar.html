<div class="h-full flex flex-col">
    <!-- Header & Filters -->
    <div
        class="bg-white border-b border-gray-200 px-6 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Agenda de Citas</h1>
            <p class="text-sm text-gray-500">Gestiona los turnos y citas médicas.</p>
        </div>

        <div class="flex items-center gap-3">
            <!-- Doctor Filter -->
            <select [ngModel]="selectedDoctorId()" (ngModelChange)="selectedDoctorId.set($event)"
                class="block w-48 rounded-md border-gray-300 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-blue-500 border px-2">
                <option value="" disabled selected>Filtrar por Médico</option>
                <option *ngFor="let doctor of doctors()" [value]="doctor.id">{{ doctor.fullName }}</option>
            </select>

            <!-- Specialty Filter -->
            <select [ngModel]="selectedSpecialtyId()" (ngModelChange)="selectedSpecialtyId.set($event)"
                class="block w-48 rounded-md border-gray-300 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-blue-500 border px-2">
                <option value="" disabled selected>Filtrar por Especialidad</option>
                <option *ngFor="let specialty of specialties()" [value]="specialty.id">{{ specialty.name }}</option>
            </select>
        </div>

        <!-- Date Navigation -->
        <div class="flex items-center bg-gray-100 rounded-lg p-1">
            <button (click)="changeWeek(-1)"
                class="p-1 hover:bg-white hover:shadow rounded-md transition-all text-gray-600">
                <lucide-icon [img]="icons.ChevronLeft" class="w-5 h-5"></lucide-icon>
            </button>
            <span class="px-3 text-sm font-medium text-gray-900 min-w-[140px] text-center">
                {{ weekDays()[0].dayName }} {{ weekDays()[0].dayNum }} - {{ weekDays()[6].dayName }} {{
                weekDays()[6].dayNum }}
            </span>
            <button (click)="changeWeek(1)"
                class="p-1 hover:bg-white hover:shadow rounded-md transition-all text-gray-600">
                <lucide-icon [img]="icons.ChevronRight" class="w-5 h-5"></lucide-icon>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="flex-1 overflow-auto bg-gray-50 p-6">
        <div *ngIf="!selectedDoctorId() || !selectedSpecialtyId()"
            class="h-full flex flex-col items-center justify-center text-gray-400">
            <lucide-icon [img]="icons.Calendar" class="w-16 h-16 mb-4 opacity-50"></lucide-icon>
            <p class="text-lg font-medium">Selecciona un Médico y una Especialidad</p>
            <p class="text-sm">Para ver la disponibilidad y agendar citas.</p>
        </div>

        <div *ngIf="selectedDoctorId() && selectedSpecialtyId()"
            class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden min-w-[800px]">
            <!-- Header Row -->
            <div class="grid grid-cols-8 border-b border-gray-200 bg-gray-50">
                <div
                    class="p-4 text-xs font-semibold text-gray-400 uppercase tracking-wider text-center border-r border-gray-200">
                    Hora</div>
                <div *ngFor="let day of weekDays()" class="p-4 text-center border-r border-gray-200 last:border-r-0">
                    <p class="text-xs font-semibold text-gray-500 uppercase">{{ day.dayName }}</p>
                    <p class="text-lg font-bold text-gray-900">{{ day.dayNum }}</p>
                </div>
            </div>

            <!-- Time Slots -->
            <div *ngFor="let time of timeSlots" class="grid grid-cols-8 border-b border-gray-100 last:border-b-0 h-20">
                <!-- Time Label -->
                <div
                    class="p-2 text-xs font-medium text-gray-500 text-center border-r border-gray-100 flex items-center justify-center bg-gray-50/50">
                    {{ time }}
                </div>

                <!-- Days Columns -->
                <div *ngFor="let day of weekDays(); let i = index"
                    class="border-r border-gray-100 last:border-r-0 relative group p-1">
                    <!-- Logic to determine slot content -->
                    <ng-container [ngSwitch]="getSlotStatus(day.iso, time, i)">

                        <!-- Booker -->
                        <button *ngSwitchCase="'available'" (click)="openBookingModal(day.iso, time)"
                            class="w-full h-full rounded-lg border-2 border-dashed border-gray-200 hover:border-blue-400 hover:bg-blue-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all text-blue-600">
                            <lucide-icon [img]="icons.Plus" class="w-5 h-5"></lucide-icon>
                        </button>

                        <!-- Appointment Card -->
                        <div *ngSwitchCase="'booked'"
                            class="w-full h-full bg-blue-100 border-l-4 border-blue-600 rounded p-2 overflow-hidden hover:shadow-md transition-shadow cursor-pointer">
                            <p class="text-xs font-bold text-blue-800 truncate">{{ getAppointment(day.iso,
                                time)?.patientName }}</p>
                            <p class="text-[10px] text-blue-600 truncate mt-0.5">{{ getAppointment(day.iso,
                                time)?.status }}</p>
                        </div>

                        <!-- Unavailable (Blank) -->
                        <div *ngSwitchDefault class="w-full h-full bg-gray-50/30"></div>

                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div *ngIf="isModalOpen" class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50 transition-opacity" (click)="closeModal()"></div>

        <div
            class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="bg-blue-600 px-4 py-3 sm:px-6">
                <h3 class="text-base font-semibold leading-6 text-white flex items-center gap-2">
                    <lucide-icon [img]="icons.Calendar" class="w-5 h-5"></lucide-icon>
                    Agendar Cita
                </h3>
            </div>

            <div class="px-4 py-5 sm:p-6">
                <div class="mb-4 bg-blue-50 p-3 rounded-md border border-blue-100">
                    <p class="text-sm text-blue-800">
                        <strong>Fecha:</strong> {{ selectedSlot?.date }} <br>
                        <strong>Hora:</strong> {{ selectedSlot?.time }}
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Paciente</label>
                        <select [(ngModel)]="newApp.patientId"
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 border px-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="" disabled selected>Seleccionar paciente</option>
                            <option *ngFor="let p of patients()" [value]="p.id">{{ p.fullName }} ({{ p.dni }})</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Método de Pago</label>
                        <select [(ngModel)]="newApp.paymentMethod"
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 border px-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="CASH">Efectivo (En Clínica)</option>
                            <option value="YAPE">Yape</option>
                            <option value="PLIN">Plin</option>
                            <option value="CARD">Tarjeta de Crédito</option>
                        </select>
                    </div>
                    <div *ngIf="newApp.paymentMethod !== 'CASH'">
                        <label class="block text-sm font-medium text-gray-700">ID de Transacción / Comprobante</label>
                        <input [(ngModel)]="newApp.transactionId" type="text" placeholder="Ej: 12345678"
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 border px-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notas / Motivo</label>
                        <textarea [(ngModel)]="newApp.notes" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 py-2 border px-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                <button (click)="saveAppointment()" [disabled]="!newApp.patientId" type="button"
                    class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto disabled:opacity-50">Confirmar
                    Cita</button>
                <button (click)="closeModal()" type="button"
                    class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
            </div>
        </div>
    </div>
</div>