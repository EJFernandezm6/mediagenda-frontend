import{a as l}from"./chunk-MZ3EZVY4.js";import{H as c,J as d,N as U,S as I,a,b as g,cc as v,e as h,ea as D,p as f,v as m}from"./chunk-A3GKMUNS.js";var $=class p{http=I(v);apiUrl=`${l.apiUrl}/iam/users`;rolesUrl=`${l.apiUrl}/iam/roles`;doctorsUrl=`${l.apiUrl}/catalog/doctors`;doctors=D([]);constructor(){this.refreshDoctors()}refreshDoctors(){m({users:this.http.get(`${this.apiUrl}?role=DOCTOR`),profiles:this.http.get(this.doctorsUrl)}).pipe(f(({users:t,profiles:r})=>(console.log("\u{1F50D} Refreshing Doctors - Raw Users:",t),t.filter(o=>!o.roles.some(i=>i.toUpperCase()==="ADMIN")).map(o=>{let i=r.find(n=>n.userId===(o.userId||o.id));return g(a({},o),{id:o.userId||o.id,doctorId:i?.doctorId,userId:o.userId||o.id,cmp:i?.cmp||"",dni:o.dni||i?.dni||"",rating:i?.rating||0,reviewsCount:i?.reviewsCount||0,active:o.active??i?.isActive??!1})})))).subscribe({next:t=>this.doctors.set(t),error:t=>console.error("Error fetching doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(f(r=>{let e=r.find(o=>o.roleKey==="DOCTOR"||o.name.toUpperCase()==="DOCTOR");if(!e)throw new Error("Role DOCTOR not found");return e.roleId}),c(r=>{let e={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleId:r,photoUrl:t.photoUrl};return this.http.post(this.apiUrl,e)}),c(r=>{let e={userId:r.userId||r.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,e)}),c(r=>this.http.patch(`${this.doctorsUrl}/${r.doctorId}/status`,{isActive:!0})),d(()=>this.refreshDoctors()))}updateDoctor(t,r){let e=a({},r);delete e.id,delete e.userId,delete e.cmp,delete e.rating,delete e.reviewsCount,delete e.active,delete e.roles,delete e.doctorId;let o=this.http.put(`${this.apiUrl}/${t}`,e),i=new h(s=>{s.next(null),s.complete()});r.active!==void 0&&(i=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:r.active}));let n=new h(s=>{s.next(null),s.complete()}),u=r.doctorId||this.doctors().find(s=>s.id===t)?.doctorId;return(r.cmp!==void 0||r.dni!==void 0)&&u&&(n=this.http.put(`${this.doctorsUrl}/${u}`,{cmp:r.cmp||this.doctors().find(s=>s.id===t)?.cmp,dni:r.dni||this.doctors().find(s=>s.id===t)?.dni})),m([o,i,n]).pipe(d(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(d(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let r=t.filter(i=>i.score>=9).length,e=t.filter(i=>i.score<=6).length,o=(r-e)/t.length*100;return Math.round(o)}static \u0275fac=function(r){return new(r||p)};static \u0275prov=U({token:p,factory:p.\u0275fac,providedIn:"root"})};export{$ as a};
