import{a as h}from"./chunk-MZ3EZVY4.js";import{L as c,N as a,R as U,W as $,a as l,b as u,f as g,ia as p,r as v,x as b,xc as I,yc as y}from"./chunk-4QQE477L.js";var w=class d{http=$(y);apiUrl=`${h.apiUrl}/iam/users`;rolesUrl=`${h.apiUrl}/iam/roles`;doctorsUrl=`${h.apiUrl}/catalog/doctors`;doctors=p([]);totalElements=p(0);selectableDoctors=p([]);constructor(){this.refreshDoctors(0,10,""),this.refreshSelectableDoctors()}refreshDoctors(t=0,e=10,r=""){let s=new I().set("page",t.toString()).set("size",e.toString());r&&(s=s.set("search",r)),this.http.get(`${this.doctorsUrl}/with-users`,{params:s}).subscribe({next:i=>{this.doctors.set(i.content.map(n=>u(l({},n),{id:n.userId,active:n.isActive}))),this.totalElements.set(i.totalElements)},error:i=>console.error("Error fetching doctors:",i)})}refreshSelectableDoctors(){this.http.get(`${this.doctorsUrl}/selectable`).subscribe({next:t=>{this.selectableDoctors.set(t.map(e=>u(l({},e),{id:e.userId||e.id,active:e.isActive??e.active})))},error:t=>console.error("Error fetching selectable doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(v(e=>{let r=e.find(s=>s.roleKey.toUpperCase()==="DOCTOR");if(!r)throw new Error("Role DOCTOR not found");return r.roleId}),c(e=>{let r={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleIds:[e],photoUrl:t.photoUrl};return this.http.post(this.apiUrl,r)}),c(e=>{let r={userId:e.userId||e.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,r)}),c(e=>this.http.patch(`${this.doctorsUrl}/${e.doctorId}/status`,{isActive:!0})),a(()=>this.refreshDoctors()))}updateDoctor(t,e){let r=l({},e);delete r.id,delete r.userId,delete r.cmp,delete r.rating,delete r.reviewsCount,delete r.active,delete r.roles,delete r.doctorId;let s=this.doctors().find(o=>o.id===t);s&&(r.fullName||(r.fullName=s.fullName),r.email||(r.email=s.email),r.phone||(r.phone=s.phone),r.roleIds||(r.roleIds=s.roleIds??[]));let i=this.http.put(`${this.apiUrl}/${t}`,r),n=new g(o=>{o.next(null),o.complete()});e.active!==void 0&&(n=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:e.active}));let D=new g(o=>{o.next(null),o.complete()}),m=e.doctorId||this.doctors().find(o=>o.id===t)?.doctorId;if(m){let o=[];(e.cmp!==void 0||e.dni!==void 0)&&o.push(this.http.put(`${this.doctorsUrl}/${m}`,{cmp:e.cmp||this.doctors().find(f=>f.id===t)?.cmp,dni:e.dni||this.doctors().find(f=>f.id===t)?.dni})),e.active!==void 0&&o.push(this.http.patch(`${this.doctorsUrl}/${m}/status`,{isActive:e.active})),o.length>0&&(D=b(o))}return b([i,n,D]).pipe(a(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(a(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let e=t.filter(i=>i.score>=9).length,r=t.filter(i=>i.score<=6).length,s=(e-r)/t.length*100;return Math.round(s)}isProfileComplete(t){return!!(t.fullName&&t.cmp&&t.dni&&t.phone&&t.email)}static \u0275fac=function(e){return new(e||d)};static \u0275prov=U({token:d,factory:d.\u0275fac,providedIn:"root"})};export{w as a};
