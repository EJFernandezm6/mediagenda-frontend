import{a as c}from"./chunk-MZ3EZVY4.js";import{L as n,N as l,R as D,W as $,a as d,b as g,f,ia as I,r as v,x as m,yc as b}from"./chunk-4MKEYT5G.js";var y=class a{http=$(b);apiUrl=`${c.apiUrl}/iam/users`;rolesUrl=`${c.apiUrl}/iam/roles`;doctorsUrl=`${c.apiUrl}/catalog/doctors`;doctors=I([]);constructor(){this.refreshDoctors()}refreshDoctors(){this.http.get(`${this.doctorsUrl}/with-users`).subscribe({next:t=>this.doctors.set(t.map(e=>g(d({},e),{id:e.userId,active:e.isActive}))),error:t=>console.error("Error fetching doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(v(e=>{let r=e.find(i=>i.roleKey==="DOCTOR"||i.name.toUpperCase()==="DOCTOR");if(!r)throw new Error("Role DOCTOR not found");return r.roleId}),n(e=>{let r={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleIds:[e],photoUrl:t.photoUrl};return this.http.post(this.apiUrl,r)}),n(e=>{let r={userId:e.userId||e.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,r)}),n(e=>this.http.patch(`${this.doctorsUrl}/${e.doctorId}/status`,{isActive:!0})),l(()=>this.refreshDoctors()))}updateDoctor(t,e){let r=d({},e);delete r.id,delete r.userId,delete r.cmp,delete r.rating,delete r.reviewsCount,delete r.active,delete r.roles,delete r.doctorId;let i=this.doctors().find(o=>o.id===t);i&&(r.fullName||(r.fullName=i.fullName),r.email||(r.email=i.email),r.phone||(r.phone=i.phone),r.roleIds||(r.roleIds=i.roleIds??[]));let s=this.http.put(`${this.apiUrl}/${t}`,r),u=new f(o=>{o.next(null),o.complete()});e.active!==void 0&&(u=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:e.active}));let U=new f(o=>{o.next(null),o.complete()}),p=e.doctorId||this.doctors().find(o=>o.id===t)?.doctorId;if(p){let o=[];(e.cmp!==void 0||e.dni!==void 0)&&o.push(this.http.put(`${this.doctorsUrl}/${p}`,{cmp:e.cmp||this.doctors().find(h=>h.id===t)?.cmp,dni:e.dni||this.doctors().find(h=>h.id===t)?.dni})),e.active!==void 0&&o.push(this.http.patch(`${this.doctorsUrl}/${p}/status`,{isActive:e.active})),o.length>0&&(U=m(o))}return m([s,u,U]).pipe(l(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(l(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let e=t.filter(s=>s.score>=9).length,r=t.filter(s=>s.score<=6).length,i=(e-r)/t.length*100;return Math.round(i)}isProfileComplete(t){return!!(t.fullName&&t.cmp&&t.dni&&t.phone&&t.email)}static \u0275fac=function(e){return new(e||a)};static \u0275prov=D({token:a,factory:a.\u0275fac,providedIn:"root"})};export{y as a};
