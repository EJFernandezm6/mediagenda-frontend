import{a as d}from"./chunk-KX3FC5ET.js";import{H as n,J as c,N as U,S as I,a as l,ac as D,b as g,e as a,ea as v,p as h,v as f}from"./chunk-SWYYGHOG.js";var $=class p{http=I(D);apiUrl=`${d.apiUrl}/iam/users`;rolesUrl=`${d.apiUrl}/iam/roles`;doctorsUrl=`${d.apiUrl}/catalog/doctors`;doctors=v([]);constructor(){this.refreshDoctors()}refreshDoctors(){f({users:this.http.get(`${this.apiUrl}?role=DOCTOR`),profiles:this.http.get(this.doctorsUrl)}).pipe(h(({users:t,profiles:e})=>t.map(r=>{let o=e.find(s=>s.userId===(r.userId||r.id));return g(l({},r),{id:r.userId||r.id,doctorId:o?.doctorId,userId:r.userId||r.id,cmp:o?.cmp||"",dni:r.dni||o?.dni||"",rating:o?.rating||0,reviewsCount:o?.reviewsCount||0,active:r.isActive??o?.isActive??!1})}))).subscribe({next:t=>this.doctors.set(t),error:t=>console.error("Error fetching doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(h(e=>{let r=e.find(o=>o.roleKey==="DOCTOR"||o.name.toUpperCase()==="DOCTOR");if(!r)throw new Error("Role DOCTOR not found");return r.roleId}),n(e=>{let r={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleId:e,photoUrl:t.photoUrl};return this.http.post(this.apiUrl,r)}),n(e=>{let r={userId:e.userId||e.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,r)}),n(e=>this.http.patch(`${this.doctorsUrl}/${e.doctorId}/status`,{isActive:!0})),c(()=>this.refreshDoctors()))}updateDoctor(t,e){let r=l({},e);delete r.id,delete r.userId,delete r.cmp,delete r.rating,delete r.reviewsCount,delete r.active,delete r.roles,delete r.doctorId;let o=this.http.put(`${this.apiUrl}/${t}`,r),s=new a(i=>{i.next(null),i.complete()});e.active!==void 0&&(s=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:e.active}));let m=new a(i=>{i.next(null),i.complete()}),u=e.doctorId||this.doctors().find(i=>i.id===t)?.doctorId;return(e.cmp!==void 0||e.dni!==void 0)&&u&&(m=this.http.put(`${this.doctorsUrl}/${u}`,{cmp:e.cmp||this.doctors().find(i=>i.id===t)?.cmp,dni:e.dni||this.doctors().find(i=>i.id===t)?.dni})),f([o,s,m]).pipe(c(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(c(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let e=t.filter(s=>s.score>=9).length,r=t.filter(s=>s.score<=6).length,o=(e-r)/t.length*100;return Math.round(o)}static \u0275fac=function(e){return new(e||p)};static \u0275prov=U({token:p,factory:p.\u0275fac,providedIn:"root"})};export{$ as a};
