import{a as m}from"./chunk-MZ3EZVY4.js";import{Cc as I,Dc as y,L as p,N as h,R as D,W as $,a as c,b as g,f as a,ia as d,r as v,x as b}from"./chunk-NLC5TGVC.js";var w=class f{http=$(y);apiUrl=`${m.apiUrl}/iam/users`;rolesUrl=`${m.apiUrl}/iam/roles`;doctorsUrl=`${m.apiUrl}/catalog/doctors`;doctors=d([]);totalElements=d(0);selectableDoctors=d([]);constructor(){this.refreshDoctors(0,10,""),this.refreshSelectableDoctors()}refreshDoctors(t=0,e=10,r=""){let i=new I().set("page",t.toString()).set("size",e.toString());r&&(i=i.set("search",r)),this.http.get(`${this.doctorsUrl}/with-users`,{params:i}).subscribe({next:s=>{this.doctors.set(s.content.map(n=>g(c({},n),{id:n.userId,active:n.isActive}))),this.totalElements.set(s.totalElements)},error:s=>console.error("Error fetching doctors:",s)})}refreshSelectableDoctors(){this.http.get(`${this.doctorsUrl}/selectable`).subscribe({next:t=>{this.selectableDoctors.set(t.map(e=>g(c({},e),{id:e.userId||e.id,active:e.isActive??e.active})))},error:t=>console.error("Error fetching selectable doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(v(e=>{let r=e.find(i=>i.roleKey.toUpperCase()==="DOCTOR");if(!r)throw new Error("Role DOCTOR not found");return r.roleId}),p(e=>{let r={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleIds:[e],photoUrl:t.photoUrl};return this.http.post(this.apiUrl,r)}),p(e=>{let r={userId:e.userId||e.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,r)}),p(e=>this.http.patch(`${this.doctorsUrl}/${e.doctorId}/status`,{isActive:!0})),h(()=>this.refreshDoctors()))}updateDoctor(t,e){let r=c({},e);delete r.id,delete r.userId,delete r.cmp,delete r.rating,delete r.reviewsCount,delete r.active,delete r.roles,delete r.doctorId;let i=Object.keys(r).length>0,s=new a(o=>{o.next(null),o.complete()});if(i){let o=this.doctors().find(l=>l.id===t);o&&(r.fullName||(r.fullName=o.fullName),r.email||(r.email=o.email),r.phone||(r.phone=o.phone),r.roleIds||(r.roleIds=o.roleIds??[])),s=this.http.put(`${this.apiUrl}/${t}`,r)}let n=new a(o=>{o.next(null),o.complete()});e.active!==void 0&&(n=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:e.active}));let U=new a(o=>{o.next(null),o.complete()}),u=e.doctorId||this.doctors().find(o=>o.id===t)?.doctorId;if(u){let o=[];(e.cmp!==void 0||e.dni!==void 0)&&o.push(this.http.put(`${this.doctorsUrl}/${u}`,{cmp:e.cmp||this.doctors().find(l=>l.id===t)?.cmp,dni:e.dni||this.doctors().find(l=>l.id===t)?.dni})),e.active!==void 0&&o.push(this.http.patch(`${this.doctorsUrl}/${u}/status`,{isActive:e.active})),o.length>0&&(U=b(o))}return b([s,n,U]).pipe(h(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(h(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let e=t.filter(s=>s.score>=9).length,r=t.filter(s=>s.score<=6).length,i=(e-r)/t.length*100;return Math.round(i)}isProfileComplete(t){return!!(t.fullName&&t.cmp&&t.dni&&t.phone&&t.email)}static \u0275fac=function(e){return new(e||f)};static \u0275prov=D({token:f,factory:f.\u0275fac,providedIn:"root"})};export{w as a};
