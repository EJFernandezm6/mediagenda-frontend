import{a as ue}from"./chunk-CZLLPRWN.js";import{a as ie}from"./chunk-F6GV6QWL.js";import{a as me}from"./chunk-O2HDX2N7.js";import"./chunk-LOEGEAMJ.js";import{a as j}from"./chunk-ZMCEOOHI.js";import{b as ne,d as oe,g as se,l as le,m as ae,n as de,u as ce}from"./chunk-PQ4WWZMQ.js";import{a as pe}from"./chunk-FN6J36XO.js";import"./chunk-MZ3EZVY4.js";import{$ as f,Ab as w,Ba as l,Bb as E,Cd as Q,Dd as Y,Hb as O,Hc as B,Hd as Z,Jd as ee,Ld as te,Md as re,Qb as D,Ra as N,Va as _,W as v,a as M,aa as h,ab as a,bb as s,cb as o,db as x,eb as R,fb as A,gc as P,hb as C,hc as V,ia as y,ib as u,ic as F,jb as g,jd as z,md as q,pc as $,qb as k,rd as W,sb as L,td as K,ub as d,ud as G,vb as U,wb as S,wd as J,xa as T,yd as X,zb as I,zd as H}from"./chunk-4MKEYT5G.js";var he=(c,t)=>({"bg-purple-50 text-purple-700 border-purple-100":c,"bg-blue-50 text-blue-700 border-blue-100":t});function xe(c,t){if(c&1&&(s(0,"span",45),d(1),o()),c&2){let e=g().$implicit;a("ngClass",O(2,he,e.toUpperCase()==="ADMIN",e.toUpperCase()==="DOCTOR")),l(),S(" ",e.toUpperCase()==="DOCTOR"?"Especialista":"Administrador"," ")}}function be(c,t){if(c&1&&(R(0),_(1,xe,2,5,"span",44),A()),c&2){let e=t.$implicit;l(),a("ngIf",e.toUpperCase()!=="STAFF")}}function _e(c,t){c&1&&(s(0,"span",46),x(1,"div",47),d(2," Activo "),o())}function ve(c,t){c&1&&(s(0,"span",48),x(1,"div",49),d(2," Inactivo "),o())}function ye(c,t){if(c&1){let e=C();s(0,"tr",27)(1,"td",28)(2,"div",29)(3,"div",30)(4,"img",31,0),u("error",function(){let i=f(e).$implicit,n=k(5);return h(n.src="https://ui-avatars.com/api/?name="+i.fullName+"&background=F3F4F6&color=6B7280")}),o()(),s(6,"div")(7,"div",32),d(8),o(),s(9,"div",33),d(10),o()()()(),s(11,"td",28)(12,"div",34),_(13,be,2,1,"ng-container",35),o()(),s(14,"td",28),_(15,_e,3,0,"span",36)(16,ve,3,0,"span",37),o(),s(17,"td",38)(18,"div",39)(19,"button",40),u("click",function(){let i=f(e).$implicit,n=g();return h(n.toggleAdmin(i))}),x(20,"lucide-icon",6),o(),s(21,"button",41),u("click",function(){let i=f(e).$implicit,n=g();return h(n.toggleSpecialist(i))}),x(22,"lucide-icon",6),o(),s(23,"button",42),u("click",function(){let i=f(e).$implicit,n=g();return h(n.toggleActive(i))}),x(24,"lucide-icon",6),o(),s(25,"button",43),u("click",function(){let i=f(e).$implicit,n=g();return h(n.editUser(i))}),x(26,"lucide-icon",6),o()()()()}if(c&2){let e,r,i,n,m=t.$implicit,p=g();l(4),a("src",m.photoUrl||"https://ui-avatars.com/api/?name="+m.fullName+"&background=F3F4F6&color=6B7280",T),l(4),U(m.fullName),l(2),U(m.email),l(3),a("ngForOf",m.roles),l(2),a("ngIf",m.active),l(),a("ngIf",!m.active),l(3),a("disabled",m.id===((e=p.currentUser())==null?null:e.id))("ngClass",p.hasRoleInUser(m,"ADMIN")?"text-purple-600 bg-purple-50 hover:bg-purple-100":"text-gray-400 hover:text-purple-600 hover:bg-purple-50")("title",m.id===((r=p.currentUser())==null?null:r.id)?"No puedes quitarte el rol de administrador a ti mismo":"Alternar Administrador"),l(),a("img",p.Icons.Shield),l(),a("ngClass",p.hasRoleInUser(m,"DOCTOR")?"text-blue-600 bg-blue-50 hover:bg-blue-100":"text-gray-400 hover:text-blue-600 hover:bg-blue-50"),l(),a("img",p.Icons.Stethoscope),l(),a("disabled",m.id===((i=p.currentUser())==null?null:i.id))("ngClass",m.active?"text-emerald-600 bg-emerald-50 hover:bg-emerald-100 disabled:opacity-50 disabled:cursor-not-allowed":"text-red-500 bg-red-50 hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed")("title",m.id===((n=p.currentUser())==null?null:n.id)?"No puedes desactivarte a ti mismo":m.active?"Desactivar Usuario":"Activar Usuario"),l(),a("img",p.Icons.Power),l(2),a("img",p.Icons.Pencil)}}function Ce(c,t){if(c&1){let e=C();s(0,"label",70)(1,"input",71),u("change",function(){let i=f(e).$implicit,n=g(2);return h(n.toggleRole(i))}),o(),s(2,"span",72),d(3),o()()}if(c&2){let e=t.$implicit,r=g(2);L("border-blue-500",r.isRoleSelected(e))("bg-blue-50",r.isRoleSelected(e)),l(),a("checked",r.isRoleSelected(e)),l(2),U(e.name)}}function Ue(c,t){c&1&&(s(0,"p",73),d(1," Selecciona al menos un rol "),o())}function Se(c,t){c&1&&(s(0,"p",74),d(1,"* El correo electr\xF3nico no puede ser modificado."),o())}function Ie(c,t){if(c&1){let e=C();s(0,"div",50)(1,"div",51)(2,"div",52)(3,"h2",53),d(4),o(),s(5,"button",54),u("click",function(){f(e);let i=g();return h(i.closeModal())}),x(6,"lucide-icon",55),o()(),s(7,"div",56)(8,"div")(9,"label",57),d(10,"Roles *"),o(),s(11,"div",58),_(12,Ce,4,6,"label",59),o(),_(13,Ue,2,0,"p",60),o(),s(14,"div",61)(15,"label",62),d(16,"Nombre Completo"),o(),s(17,"div",63)(18,"input",64),E("ngModelChange",function(i){f(e);let n=g();return w(n.formData.fullName,i)||(n.formData.fullName=i),h(i)}),o(),x(19,"lucide-icon",9),o()(),s(20,"div",61)(21,"label",62),d(22,"Correo Electr\xF3nico"),o(),s(23,"div",63)(24,"input",65),E("ngModelChange",function(i){f(e);let n=g();return w(n.formData.email,i)||(n.formData.email=i),h(i)}),o(),x(25,"lucide-icon",9),o(),_(26,Se,2,0,"p",66),o()(),s(27,"div",67)(28,"button",68),u("click",function(){f(e);let i=g();return h(i.closeModal())}),d(29," Cancelar "),o(),s(30,"button",69),u("click",function(){f(e);let i=g();return h(i.saveUser())}),d(31),o()()()()}if(c&2){let e=g();l(4),S(" ",e.isEditing?"Editar Usuario":"Nuevo Usuario"," "),l(2),a("img",e.Icons.X),l(6),a("ngForOf",e.availableRoles),l(),a("ngIf",e.formData.roles.length===0),l(5),I("ngModel",e.formData.fullName),l(),a("img",e.Icons.User),l(5),I("ngModel",e.formData.email),a("disabled",e.isEditing),l(),a("img",e.Icons.Mail),l(),a("ngIf",e.isEditing),l(4),a("disabled",!e.isValid()),l(),S(" ",e.isEditing?"Guardar Cambios":"Crear Usuario"," ")}}var ge=class c{usersService=v(ue);authService=v(ie);confirmService=v(j);doctorsService=v(pe);Icons={Plus:K,Search:J,Trash2:Y,Pencil:W,Mail:q,BadgeCheck:B,X:ee,User:Z,Lock:z,ShieldCheck:X,Shield:H,Power:G,Stethoscope:Q};users=this.usersService.users;searchTerm=y("");selectedRole=y("");selectedStatus=y("");currentPage=y(1);itemsPerPage=10;isModalOpen=!1;isEditing=!1;editingId=null;formData={fullName:"",email:"",password:"123456",roles:[],cmp:"",clinicId:"",roleIds:[],phone:"",photoUrl:""};currentUser=this.authService.currentUser;filteredUsers=D(()=>{let t=this.users(),e=this.searchTerm().toLowerCase(),r=this.selectedRole(),i=this.selectedStatus();if(e&&(t=t.filter(n=>n.fullName.toLowerCase().includes(e)||n.email.toLowerCase().includes(e)||n.cmp&&n.cmp.toLowerCase().includes(e))),r&&(t=t.filter(n=>n.roles.some(m=>m.toUpperCase()===r.toUpperCase()))),i){let n=i==="ACTIVE";t=t.filter(m=>m.active===n)}return t});paginatedUsers=D(()=>{let t=this.filteredUsers(),e=(this.currentPage()-1)*this.itemsPerPage;return t.slice(e,e+this.itemsPerPage)});availableRoles=[];constructor(){this.usersService.refreshUsers(),this.usersService.getRoles().subscribe({next:t=>{this.availableRoles=t},error:t=>console.error("Error loading roles:",t)})}onPageChange(t){this.currentPage.set(t)}filterByRole(t){this.selectedRole.set(t),this.currentPage.set(1)}filterByStatus(t){this.selectedStatus.set(t),this.currentPage.set(1)}onSearch(t){this.searchTerm.set(t),this.currentPage.set(1)}hasRole(t){return this.formData.roles.some(e=>e.toUpperCase()===t.toUpperCase())}hasRoleInUser(t,e){return t.roles.some(r=>r.toUpperCase()===e.toUpperCase())}openModal(){this.isEditing=!1,this.editingId=null,this.formData={fullName:"",email:"",password:"123456",roles:[],cmp:"",clinicId:"",roleIds:[],phone:"",photoUrl:""},this.isModalOpen=!0}editUser(t){this.isEditing=!0,this.editingId=t.id,this.formData={fullName:t.fullName,email:t.email,password:"",roles:[...t.roles],cmp:t.cmp||"",clinicId:t.clinicId,roleIds:t.roleIds??[],phone:t.phone||"",photoUrl:t.photoUrl||""},this.isModalOpen=!0}closeModal(){this.isModalOpen=!1}saveUser(){if(this.isEditing&&this.editingId){let t={fullName:this.formData.fullName,phone:this.formData.phone,roleIds:this.formData.roleIds?.length?this.formData.roleIds:void 0,photoUrl:this.formData.photoUrl};console.log("\u{1F504} Updating user:",this.editingId,"with payload:",t),this.usersService.updateUser(this.editingId,t).subscribe({next:()=>{console.log("\u2705 User updated successfully"),this.closeModal()},error:e=>{console.error("\u274C Error updating user:",e),alert("Error al actualizar usuario. Verifique los datos.")}})}else{let t=this.currentUser();t?.clinicId&&(this.formData.clinicId=t.clinicId);let e=M({},this.formData);e.roleIds?.length||delete e.roleIds,e.cmp||delete e.cmp,this.usersService.addUser(e).subscribe({next:()=>this.closeModal(),error:r=>{console.error("Error adding user:",r);let i="Error al crear usuario.";r.error?.message?i=r.error.message:r.error?.errors?i=JSON.stringify(r.error.errors):r.message&&(i=r.message),alert(i)}})}}async toggleAdmin(t){let e=this.hasRoleInUser(t,"ADMIN"),r=e?"quitar":"asignar";if(!await this.confirmService.confirm({title:"Cambiar Rol de Administrador",message:`\xBFEst\xE1s seguro de ${r} el rol de Administrador para ${t.fullName}?`,confirmText:"Confirmar",cancelText:"Cancelar"}))return;let n=[...t.roles];e?n=n.filter(m=>m.toUpperCase()!=="ADMIN"):n.push("ADMIN"),this.updateUserRoles(t.id,n)}async toggleActive(t){if(t.id===this.currentUser()?.id){alert("No puedes desactivar tu propia cuenta mientras est\xE1s logueado.");return}let e=t.active?"desactivar":"activar";if(!await this.confirmService.confirm({title:`${e.charAt(0).toUpperCase()+e.slice(1)} Usuario`,message:`\xBFEst\xE1s seguro de ${e} a ${t.fullName}?`,confirmText:e.charAt(0).toUpperCase()+e.slice(1),cancelText:"Cancelar"}))return;let i=this.hasRoleInUser(t,"DOCTOR"),n=!t.active;(i?this.doctorsService.updateDoctor(t.id,{active:n}):this.usersService.toggleUserActive(t.id)).subscribe({next:()=>{i||this.usersService.refreshUsers()},error:p=>{console.error("Error toggling active status:",p),alert("Error al cambiar el estado. Por favor intente nuevamente.")}})}async toggleSpecialist(t){let e=this.hasRoleInUser(t,"DOCTOR"),r=e?"quitar":"asignar";if(!await this.confirmService.confirm({title:"Cambiar Rol de Especialista",message:`\xBFEst\xE1s seguro de ${r} el rol de Especialista para ${t.fullName}?`,confirmText:"Confirmar",cancelText:"Cancelar"}))return;let n=[...t.roles];e?n=n.filter(m=>m.toUpperCase()!=="DOCTOR"):n.push("DOCTOR"),this.updateUserRoles(t.id,n)}updateUserRoles(t,e){let r=this.users().find(b=>b.id===t);if(!r){console.error("User not found for role update");return}let i="PATIENT";e.some(b=>b.toUpperCase()==="ADMIN")?i="ADMIN":e.some(b=>b.toUpperCase()==="DOCTOR")?i="DOCTOR":e.length>0&&(i=e[0].toUpperCase());let n=this.availableRoles.find(b=>b.roleKey===i||b.name.toUpperCase()===i),m=n?n.roleId:r.roleIds?.[0],p={fullName:r.fullName,email:r.email,roles:e,roleIds:m?[m]:[],phone:r.phone,photoUrl:r.photoUrl,clinicId:r.clinicId,cmp:r.cmp};p.roleIds?.length||console.warn("Warning: Could not determine valid roleIds for roles:",e),this.usersService.updateUser(t,p).subscribe({next:()=>{this.usersService.refreshUsers()},error:b=>{console.error("Error updating roles:",b);let fe=b.error?.message||"Error al actualizar los roles.";alert(fe)}})}toggleRole(t){let e=this.formData.roleIds.indexOf(t.roleId);e>=0?(this.formData.roleIds.splice(e,1),this.formData.roles=this.formData.roles.filter(r=>r!==t.roleKey)):(this.formData.roleIds.push(t.roleId),this.formData.roles.push(t.roleKey))}isRoleSelected(t){return this.formData.roleIds.includes(t.roleId)}isValid(){return!(!this.formData.fullName||!this.formData.email||!this.isEditing&&!this.formData.password||this.formData.roles.length===0||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.formData.email))}static \u0275fac=function(e){return new(e||c)};static \u0275cmp=N({type:c,selectors:[["app-users-list"]],decls:44,vars:10,consts:[["uImg",""],[1,"p-6"],[1,"flex","justify-between","items-center","mb-6"],[1,"text-2xl","font-bold","text-gray-900"],[1,"text-gray-500"],[1,"btn","btn-primary","flex","items-center","gap-2",3,"click"],[1,"w-4","h-4",3,"img"],[1,"bg-white","p-4","rounded-lg","shadow-sm","border","border-gray-100","mb-6","flex","gap-4"],[1,"relative","flex-1"],[1,"absolute","left-3","top-1/2","-translate-y-1/2","w-5","h-5","text-gray-400",3,"img"],["type","text","placeholder","Buscar por nombre o email...",1,"w-full","pl-12","pr-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all",3,"ngModelChange","ngModel"],[1,"px-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","bg-white","min-w-[150px]",3,"ngModelChange","ngModel"],["value",""],["value","ACTIVE"],["value","INACTIVE"],[1,"px-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","bg-white","min-w-[200px]",3,"ngModelChange","ngModel"],["value","ADMIN"],["value","DOCTOR"],[1,"bg-white","rounded-xl","shadow-sm","border","border-gray-100","overflow-hidden"],[1,"w-full"],[1,"bg-gray-50","border-b","border-gray-100"],[1,"px-6","py-4","text-left","text-xs","font-semibold","text-gray-500","uppercase","tracking-wider"],[1,"px-6","py-4","text-right","text-xs","font-semibold","text-gray-500","uppercase","tracking-wider"],[1,"divide-y","divide-gray-100"],["class","hover:bg-gray-50 transition-colors group",4,"ngFor","ngForOf"],[3,"pageChange","currentPage","totalItems","pageSize"],["class","fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4",4,"ngIf"],[1,"hover:bg-gray-50","transition-colors","group"],[1,"px-6","py-4"],[1,"flex","items-center","gap-3"],[1,"w-10","h-10","rounded-full","bg-primary/10","flex","items-center","justify-center","text-primary","font-bold","shadow-sm","overflow-hidden","border","border-gray-100"],[1,"w-full","h-full","object-cover",3,"error","src"],[1,"font-medium","text-gray-900","group-hover:text-primary","transition-colors"],[1,"text-sm","text-gray-500"],[1,"flex","gap-1","flex-wrap"],[4,"ngFor","ngForOf"],["class","inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100",4,"ngIf"],["class","inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100",4,"ngIf"],[1,"px-6","py-4","text-right"],[1,"flex","justify-end","gap-2"],[1,"p-2","rounded-lg","transition-all","disabled:opacity-30","disabled:cursor-not-allowed",3,"click","disabled","ngClass","title"],["title","Alternar Especialista",1,"p-2","rounded-lg","transition-all",3,"click","ngClass"],[1,"p-2","rounded-lg","transition-all",3,"click","disabled","ngClass","title"],["title","Editar",1,"p-2","text-gray-400","hover:text-blue-600","hover:bg-blue-50","rounded-lg","transition-all",3,"click"],["class","px-2.5 py-0.5 rounded-full text-xs font-medium border shadow-sm",3,"ngClass",4,"ngIf"],[1,"px-2.5","py-0.5","rounded-full","text-xs","font-medium","border","shadow-sm",3,"ngClass"],[1,"inline-flex","items-center","gap-1.5","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-emerald-50","text-emerald-700","border","border-emerald-100"],[1,"w-1.5","h-1.5","rounded-full","bg-emerald-500"],[1,"inline-flex","items-center","gap-1.5","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-red-50","text-red-700","border","border-red-100"],[1,"w-1.5","h-1.5","rounded-full","bg-red-500"],[1,"fixed","inset-0","bg-black/50","z-50","flex","items-center","justify-center","backdrop-blur-sm","p-4"],[1,"bg-white","rounded-2xl","shadow-xl","w-full","max-w-lg","flex","flex-col","max-h-[90vh]"],[1,"px-6","py-4","border-b","border-gray-100","flex","justify-between","items-center","bg-gray-50","rounded-t-2xl","flex-shrink-0"],[1,"text-lg","font-semibold","text-gray-900"],[1,"text-gray-400","hover:text-gray-600","hover:bg-gray-100","p-2","rounded-full","transition-all",3,"click"],[1,"w-5","h-5",3,"img"],[1,"p-6","space-y-5","overflow-y-auto"],[1,"block","text-sm","font-medium","text-gray-700","mb-2"],[1,"grid","grid-cols-2","gap-2"],["class","flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50",3,"border-blue-500","bg-blue-50",4,"ngFor","ngForOf"],["class","text-xs text-red-500 mt-1",4,"ngIf"],[1,"space-y-2"],[1,"block","text-sm","font-medium","text-gray-700"],[1,"relative"],["type","text","autocomplete","off","placeholder","Ej: Juan P\xE9rez",1,"w-full","px-4","py-2","border","border-gray-200","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all","pl-12",3,"ngModelChange","ngModel"],["type","email","autocomplete","off","placeholder","correo@ejemplo.com",1,"w-full","px-4","py-2","border","border-gray-200","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all","pl-12","disabled:bg-gray-50","disabled:text-gray-500","disabled:cursor-not-allowed",3,"ngModelChange","ngModel","disabled"],["class","text-[10px] text-gray-400 mt-1 italic",4,"ngIf"],[1,"px-6","py-4","border-t","border-gray-100","flex","justify-end","gap-3","bg-gray-50","rounded-b-2xl","flex-shrink-0"],[1,"px-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","hover:bg-gray-50","transition-all","font-medium",3,"click"],[1,"px-4","py-2","bg-primary","text-white","rounded-lg","hover:bg-primary/90","transition-all","font-medium","disabled:opacity-50","disabled:cursor-not-allowed","shadow-sm","shadow-primary/20",3,"click","disabled"],[1,"flex","items-center","gap-2","p-2","border","rounded-lg","cursor-pointer","hover:bg-gray-50"],["type","checkbox",1,"rounded",3,"change","checked"],[1,"text-sm","font-medium"],[1,"text-xs","text-red-500","mt-1"],[1,"text-[10px]","text-gray-400","mt-1","italic"]],template:function(e,r){e&1&&(s(0,"div",1)(1,"div",2)(2,"div")(3,"h1",3),d(4,"Gesti\xF3n de Usuarios"),o(),s(5,"p",4),d(6,"Administra el acceso y roles del sistema"),o()(),s(7,"button",5),u("click",function(){return r.openModal()}),x(8,"lucide-icon",6),d(9," Nuevo Usuario "),o()(),s(10,"div",7)(11,"div",8),x(12,"lucide-icon",9),s(13,"input",10),u("ngModelChange",function(n){return r.onSearch(n)}),o()(),s(14,"select",11),u("ngModelChange",function(n){return r.filterByStatus(n)}),s(15,"option",12),d(16,"Todos los estados"),o(),s(17,"option",13),d(18,"Activos"),o(),s(19,"option",14),d(20,"Inactivos"),o()(),s(21,"select",15),u("ngModelChange",function(n){return r.filterByRole(n)}),s(22,"option",12),d(23,"Todos los roles"),o(),s(24,"option",16),d(25,"Administradores"),o(),s(26,"option",17),d(27,"Especialistas"),o()()(),s(28,"div",18)(29,"table",19)(30,"thead",20)(31,"tr")(32,"th",21),d(33,"Usuario "),o(),s(34,"th",21),d(35,"Rol "),o(),s(36,"th",21),d(37,"Estado "),o(),s(38,"th",22),d(39," Acciones"),o()()(),s(40,"tbody",23),_(41,ye,27,17,"tr",24),o()(),s(42,"app-pagination",25),u("pageChange",function(n){return r.onPageChange(n)}),o()()(),_(43,Ie,32,12,"div",26)),e&2&&(l(8),a("img",r.Icons.Plus),l(4),a("img",r.Icons.Search),l(),a("ngModel",r.searchTerm()),l(),a("ngModel",r.selectedStatus()),l(7),a("ngModel",r.selectedRole()),l(20),a("ngForOf",r.paginatedUsers()),l(),a("currentPage",r.currentPage())("totalItems",r.filteredUsers().length)("pageSize",r.itemsPerPage),l(),a("ngIf",r.isModalOpen))},dependencies:[$,P,V,F,ce,ae,de,ne,le,oe,se,re,te,me],encapsulation:2})};export{ge as UsersListComponent};
