import{a as de}from"./chunk-2MA4KILF.js";import{a as ae}from"./chunk-LZP63J3R.js";import"./chunk-AJN7Q7O3.js";import{b as ce,c as pe,f as me,i as ue,j as ge,k as fe,o as he}from"./chunk-DOKJHZWU.js";import{a as A}from"./chunk-MZ3EZVY4.js";import{$a as m,Bb as P,H as D,Ia as L,J as x,Kc as J,Ma as b,N as k,Nc as X,S as v,Sb as j,Sc as K,Ta as d,Tb as B,Ua as o,Ub as W,Uc as Q,Va as s,Vc as Y,Wa as p,X as g,Xa as V,Xb as q,Xc as Z,Y as f,Ya as F,Za as I,Zc as ee,_a as u,_c as te,a as y,b as N,bc as z,bd as re,cc as G,cd as ie,ea as _,eb as O,fd as ne,hb as c,hd as oe,ib as M,jb as U,jd as se,kc as H,kd as le,mb as C,nb as w,ob as E,p as T,ra as R,sb as $,ta as l}from"./chunk-A3GKMUNS.js";var S=class a{http=v(G);apiUrl=`${A.apiUrl}/iam/users`;users=_([]);_currentRole="";constructor(){this.refreshUsers()}refreshUsers(e){e!==void 0&&(this._currentRole=e);let t=new z;this._currentRole&&(t=t.set("role",this._currentRole)),this.http.get(this.apiUrl,{params:t}).pipe(x(i=>console.log("Raw users data:",i)),T(i=>i.map(r=>N(y({},r),{id:r.userId||r.id,fullName:r.fullName||r.name})))).subscribe({next:i=>this.users.set(i),error:i=>console.error("Error fetching users:",i)})}getUsers(){return this.users()}rolesUrl=`${A.apiUrl}/iam/roles`;getRoles(){return this.http.get(this.rolesUrl)}addUser(e){return this.getRoles().pipe(D(t=>{let i=e.roles.includes("ADMIN")?"ADMIN":e.roles[0],r=t.find(h=>h.roleKey===i||h.name.toUpperCase()===i);if(!r)throw new Error(`Role ${i} not found`);let n={fullName:e.fullName,email:e.email,password:e.password,roleId:r.roleId,phone:e.phone||"",photoUrl:e.photoUrl||""};return console.log("\u{1F50D} Role found:",r),console.log("\u{1F4E4} Final payload to send:",n),this.http.post(this.apiUrl,n)}),x(()=>this.refreshUsers()))}updateUser(e,t){return this.http.put(`${this.apiUrl}/${e}`,t).pipe(x(()=>this.refreshUsers()))}deleteUser(e){return this.http.delete(`${this.apiUrl}/${e}`).pipe(x(()=>this.refreshUsers()))}toggleAdminRole(e){return this.http.post(`${this.apiUrl}/${e}/toggle-admin`,{}).pipe(x(()=>this.refreshUsers()))}toggleSpecialistRole(e){return this.http.post(`${this.apiUrl}/${e}/toggle-specialist`,{}).pipe(x(()=>this.refreshUsers()))}toggleUserActive(e){return this.http.post(`${this.apiUrl}/${e}/toggle-active`,{}).pipe(x(()=>this.refreshUsers()))}static \u0275fac=function(t){return new(t||a)};static \u0275prov=k({token:a,factory:a.\u0275fac,providedIn:"root"})};var ve=(a,e)=>({"bg-purple-50 text-purple-700 border-purple-100":a,"bg-blue-50 text-blue-700 border-blue-100":e});function _e(a,e){if(a&1&&(o(0,"span",44),c(1),s()),a&2){let t=m().$implicit;d("ngClass",$(2,ve,t.toUpperCase()==="ADMIN",t.toUpperCase()==="DOCTOR")),l(),U(" ",t.toUpperCase()==="DOCTOR"?"Especialista":"Administrador"," ")}}function ye(a,e){if(a&1&&(V(0),b(1,_e,2,5,"span",43),F()),a&2){let t=e.$implicit;l(),d("ngIf",t.toUpperCase()!=="STAFF")}}function Ue(a,e){a&1&&(o(0,"span",45),p(1,"div",46),c(2," Activo "),s())}function Ce(a,e){a&1&&(o(0,"span",47),p(1,"div",48),c(2," Inactivo "),s())}function we(a,e){if(a&1){let t=I();o(0,"tr",26)(1,"td",27)(2,"div",28)(3,"div",29)(4,"img",30,0),u("error",function(){let r=g(t).$implicit,n=O(5);return f(n.src="https://ui-avatars.com/api/?name="+r.fullName+"&background=F3F4F6&color=6B7280")}),s()(),o(6,"div")(7,"div",31),c(8),s(),o(9,"div",32),c(10),s()()()(),o(11,"td",27)(12,"div",33),b(13,ye,2,1,"ng-container",34),s()(),o(14,"td",27),b(15,Ue,3,0,"span",35)(16,Ce,3,0,"span",36),s(),o(17,"td",37)(18,"div",38)(19,"button",39),u("click",function(){let r=g(t).$implicit,n=m();return f(n.toggleAdmin(r))}),p(20,"lucide-icon",6),s(),o(21,"button",40),u("click",function(){let r=g(t).$implicit,n=m();return f(n.toggleSpecialist(r))}),p(22,"lucide-icon",6),s(),o(23,"button",41),u("click",function(){let r=g(t).$implicit,n=m();return f(n.toggleActive(r))}),p(24,"lucide-icon",6),s(),o(25,"button",42),u("click",function(){let r=g(t).$implicit,n=m();return f(n.editUser(r))}),p(26,"lucide-icon",6),s()()()()}if(a&2){let t,i,r=e.$implicit,n=m();l(4),d("src",r.photoUrl||"https://ui-avatars.com/api/?name="+r.fullName+"&background=F3F4F6&color=6B7280",R),l(4),M(r.fullName),l(2),M(r.email),l(3),d("ngForOf",r.roles),l(2),d("ngIf",r.active),l(),d("ngIf",!r.active),l(3),d("disabled",r.id===((t=n.currentUser())==null?null:t.id))("ngClass",n.hasRoleInUser(r,"ADMIN")?"text-purple-600 bg-purple-50 hover:bg-purple-100":"text-gray-400 hover:text-purple-600 hover:bg-purple-50")("title",r.id===((i=n.currentUser())==null?null:i.id)?"No puedes quitarte el rol de administrador a ti mismo":"Alternar Administrador"),l(),d("img",n.Icons.Shield),l(),d("ngClass",n.hasRoleInUser(r,"DOCTOR")?"text-blue-600 bg-blue-50 hover:bg-blue-100":"text-gray-400 hover:text-blue-600 hover:bg-blue-50"),l(),d("img",n.Icons.Stethoscope),l(),d("ngClass",r.active?"text-emerald-600 bg-emerald-50 hover:bg-emerald-100":"text-red-500 bg-red-50 hover:bg-red-100")("title",r.active?"Desactivar Usuario":"Activar Usuario"),l(),d("img",n.Icons.Power),l(2),d("img",n.Icons.Pencil)}}function Ee(a,e){if(a&1&&(o(0,"div",67),p(1,"lucide-icon",68),o(2,"div")(3,"span",69),c(4,"Creando Administrador"),s(),c(5," Este usuario tendr\xE1 acceso completo al sistema. Para registrar doctores, usa el m\xF3dulo de Especialistas. "),s()()),a&2){let t=m(2);l(),d("img",t.Icons.ShieldCheck)}}function Se(a,e){a&1&&(o(0,"p",70),c(1,"* El correo electr\xF3nico no puede ser modificado."),s())}function Ie(a,e){if(a&1){let t=I();o(0,"div",49)(1,"div",50)(2,"div",51)(3,"h2",52),c(4),s(),o(5,"button",53),u("click",function(){g(t);let r=m();return f(r.closeModal())}),p(6,"lucide-icon",54),s()(),o(7,"div",55),b(8,Ee,6,1,"div",56),o(9,"div",57)(10,"label",58),c(11,"Nombre Completo"),s(),o(12,"div",59)(13,"input",60),E("ngModelChange",function(r){g(t);let n=m();return w(n.formData.fullName,r)||(n.formData.fullName=r),f(r)}),s(),p(14,"lucide-icon",9),s()(),o(15,"div",57)(16,"label",58),c(17,"Correo Electr\xF3nico"),s(),o(18,"div",59)(19,"input",61),E("ngModelChange",function(r){g(t);let n=m();return w(n.formData.email,r)||(n.formData.email=r),f(r)}),s(),p(20,"lucide-icon",9),s(),b(21,Se,2,0,"p",62),s(),p(22,"div",63),s(),o(23,"div",64)(24,"button",65),u("click",function(){g(t);let r=m();return f(r.closeModal())}),c(25," Cancelar "),s(),o(26,"button",66),u("click",function(){g(t);let r=m();return f(r.saveUser())}),c(27),s()()()()}if(a&2){let t=m();l(4),U(" ",t.isEditing?"Editar Usuario":"Nuevo Usuario"," "),l(2),d("img",t.Icons.X),l(2),d("ngIf",!t.isEditing),l(5),C("ngModel",t.formData.fullName),l(),d("img",t.Icons.User),l(5),C("ngModel",t.formData.email),d("disabled",t.isEditing),l(),d("img",t.Icons.Mail),l(),d("ngIf",t.isEditing),l(5),d("disabled",!t.isValid()),l(),U(" ",t.isEditing?"Guardar Cambios":"Crear Usuario"," ")}}var xe=class a{usersService=v(S);authService=v(de);confirmService=v(ae);Icons={Plus:Q,Search:Z,Trash2:ie,Pencil:K,Mail:X,BadgeCheck:H,X:oe,User:ne,Lock:J,ShieldCheck:ee,Shield:te,Power:Y,Stethoscope:re};users=this.usersService.users;searchTerm=_("");selectedRole=_("");selectedStatus=_("");isModalOpen=!1;isEditing=!1;editingId=null;formData={fullName:"",email:"",password:"123456",roles:["ADMIN"],cmp:"",clinicId:"",roleId:"",phone:"",photoUrl:""};currentUser=this.authService.currentUser;filteredUsers=P(()=>{let e=this.users(),t=this.searchTerm().toLowerCase(),i=this.selectedRole(),r=this.selectedStatus();if(t&&(e=e.filter(n=>n.fullName.toLowerCase().includes(t)||n.email.toLowerCase().includes(t)||n.cmp&&n.cmp.toLowerCase().includes(t))),i&&(e=e.filter(n=>n.roles.some(h=>h.toUpperCase()===i.toUpperCase()))),r){let n=r==="ACTIVE";e=e.filter(h=>h.active===n)}return e});hasRole(e){return this.formData.roles.some(t=>t.toUpperCase()===e.toUpperCase())}hasRoleInUser(e,t){return e.roles.some(i=>i.toUpperCase()===t.toUpperCase())}constructor(){}filterByRole(e){this.selectedRole.set(e)}filterByStatus(e){this.selectedStatus.set(e)}openModal(){this.isEditing=!1,this.editingId=null,this.formData={fullName:"",email:"",password:"123456",roles:["ADMIN"],cmp:"",clinicId:"",roleId:"",phone:"",photoUrl:""},this.isModalOpen=!0}editUser(e){this.isEditing=!0,this.editingId=e.id,this.formData={fullName:e.fullName,email:e.email,password:"",roles:[...e.roles],cmp:e.cmp||"",clinicId:e.clinicId,roleId:e.roleId,phone:e.phone||"",photoUrl:e.photoUrl||""},this.isModalOpen=!0}closeModal(){this.isModalOpen=!1}saveUser(){if(this.isEditing&&this.editingId){let e={fullName:this.formData.fullName,phone:this.formData.phone,roleId:this.formData.roleId||void 0,photoUrl:this.formData.photoUrl};console.log("\u{1F504} Updating user:",this.editingId,"with payload:",e),this.usersService.updateUser(this.editingId,e).subscribe({next:()=>{console.log("\u2705 User updated successfully"),this.closeModal()},error:t=>{console.error("\u274C Error updating user:",t),alert("Error al actualizar usuario. Verifique los datos.")}})}else{let e=this.currentUser();e?.clinicId&&(this.formData.clinicId=e.clinicId);let t=y({},this.formData);t.roleId||delete t.roleId,t.cmp||delete t.cmp,this.usersService.addUser(t).subscribe({next:()=>this.closeModal(),error:i=>{console.error("Error adding user:",i);let r="Error al crear usuario.";i.error?.message?r=i.error.message:i.error?.errors?r=JSON.stringify(i.error.errors):i.message&&(r=i.message),alert(r)}})}}async toggleAdmin(e){await this.confirmService.confirm({title:"Cambiar Rol de Administrador",message:`\xBFEst\xE1s seguro de cambiar el rol de Administrador para ${e.fullName}?`,confirmText:"Confirmar",cancelText:"Cancelar"})&&this.usersService.toggleAdminRole(e.id).subscribe({next:()=>{},error:i=>{console.error("Error toggling admin role:",i),alert("Error al cambiar el rol. Por favor intente nuevamente.")}})}async toggleActive(e){let t=e.active?"desactivar":"activar";await this.confirmService.confirm({title:`${t.charAt(0).toUpperCase()+t.slice(1)} Usuario`,message:`\xBFEst\xE1s seguro de ${t} a ${e.fullName}?`,confirmText:t.charAt(0).toUpperCase()+t.slice(1),cancelText:"Cancelar"})&&this.usersService.toggleUserActive(e.id).subscribe({next:()=>{},error:r=>{console.error("Error toggling active status:",r),alert("Error al cambiar el estado. Por favor intente nuevamente.")}})}async toggleSpecialist(e){let t=this.hasRoleInUser(e,"DOCTOR"),i=t?"Quitar Rol de Especialista":"Asignar Rol de Especialista",r=t?`\xBFEst\xE1s seguro de quitar el rol de Especialista a ${e.fullName}?`:`\xBFEst\xE1s seguro de asignar el rol de Especialista a ${e.fullName}?`;await this.confirmService.confirm({title:i,message:r,confirmText:"Confirmar",cancelText:"Cancelar"})&&this.usersService.toggleSpecialistRole(e.id).subscribe({next:()=>{},error:h=>{console.error("Error toggling specialist role:",h),alert("Error al cambiar el rol. Por favor intente nuevamente.")}})}isValid(){return!(!this.formData.fullName||!this.formData.email||!this.isEditing&&!this.formData.password||this.formData.roles.length===0||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.formData.email))}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=L({type:a,selectors:[["app-users-list"]],decls:43,vars:7,consts:[["uImg",""],[1,"p-6"],[1,"flex","justify-between","items-center","mb-6"],[1,"text-2xl","font-bold","text-gray-900"],[1,"text-gray-500"],[1,"btn","btn-primary","flex","items-center","gap-2",3,"click"],[1,"w-4","h-4",3,"img"],[1,"bg-white","p-4","rounded-lg","shadow-sm","border","border-gray-100","mb-6","flex","gap-4"],[1,"relative","flex-1"],[1,"absolute","left-3","top-1/2","-translate-y-1/2","w-5","h-5","text-gray-400",3,"img"],["type","text","placeholder","Buscar por nombre o email...",1,"w-full","pl-12","pr-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all",3,"ngModelChange","ngModel"],[1,"px-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","bg-white","min-w-[150px]",3,"ngModelChange","ngModel"],["value",""],["value","ACTIVE"],["value","INACTIVE"],[1,"px-4","py-2","border","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","bg-white","min-w-[200px]",3,"ngModelChange","ngModel"],["value","ADMIN"],["value","DOCTOR"],[1,"bg-white","rounded-xl","shadow-sm","border","border-gray-100","overflow-hidden"],[1,"w-full"],[1,"bg-gray-50","border-b","border-gray-100"],[1,"px-6","py-4","text-left","text-xs","font-semibold","text-gray-500","uppercase","tracking-wider"],[1,"px-6","py-4","text-right","text-xs","font-semibold","text-gray-500","uppercase","tracking-wider"],[1,"divide-y","divide-gray-100"],["class","hover:bg-gray-50 transition-colors group",4,"ngFor","ngForOf"],["class","fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4",4,"ngIf"],[1,"hover:bg-gray-50","transition-colors","group"],[1,"px-6","py-4"],[1,"flex","items-center","gap-3"],[1,"w-10","h-10","rounded-full","bg-primary/10","flex","items-center","justify-center","text-primary","font-bold","shadow-sm","overflow-hidden","border","border-gray-100"],[1,"w-full","h-full","object-cover",3,"error","src"],[1,"font-medium","text-gray-900","group-hover:text-primary","transition-colors"],[1,"text-sm","text-gray-500"],[1,"flex","gap-1","flex-wrap"],[4,"ngFor","ngForOf"],["class","inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100",4,"ngIf"],["class","inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 border border-red-100",4,"ngIf"],[1,"px-6","py-4","text-right"],[1,"flex","justify-end","gap-2"],[1,"p-2","rounded-lg","transition-all","disabled:opacity-30","disabled:cursor-not-allowed",3,"click","disabled","ngClass","title"],["title","Alternar Especialista",1,"p-2","rounded-lg","transition-all",3,"click","ngClass"],[1,"p-2","rounded-lg","transition-all",3,"click","ngClass","title"],["title","Editar",1,"p-2","text-gray-400","hover:text-blue-600","hover:bg-blue-50","rounded-lg","transition-all",3,"click"],["class","px-2.5 py-0.5 rounded-full text-xs font-medium border shadow-sm",3,"ngClass",4,"ngIf"],[1,"px-2.5","py-0.5","rounded-full","text-xs","font-medium","border","shadow-sm",3,"ngClass"],[1,"inline-flex","items-center","gap-1.5","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-emerald-50","text-emerald-700","border","border-emerald-100"],[1,"w-1.5","h-1.5","rounded-full","bg-emerald-500"],[1,"inline-flex","items-center","gap-1.5","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-red-50","text-red-700","border","border-red-100"],[1,"w-1.5","h-1.5","rounded-full","bg-red-500"],[1,"fixed","inset-0","bg-black/50","z-50","flex","items-center","justify-center","backdrop-blur-sm","p-4"],[1,"bg-white","rounded-2xl","shadow-xl","w-full","max-w-lg","flex","flex-col","max-h-[90vh]"],[1,"px-6","py-4","border-b","border-gray-100","flex","justify-between","items-center","bg-gray-50","rounded-t-2xl","flex-shrink-0"],[1,"text-lg","font-semibold","text-gray-900"],[1,"text-gray-400","hover:text-gray-600","hover:bg-gray-100","p-2","rounded-full","transition-all",3,"click"],[1,"w-5","h-5",3,"img"],[1,"p-6","space-y-5","overflow-y-auto"],["class","bg-blue-50 text-blue-700 p-3 rounded-lg flex gap-3 text-sm items-start",4,"ngIf"],[1,"space-y-2"],[1,"block","text-sm","font-medium","text-gray-700"],[1,"relative"],["type","text","autocomplete","off","placeholder","Ej: Juan P\xE9rez",1,"w-full","px-4","py-2","border","border-gray-200","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all","pl-12",3,"ngModelChange","ngModel"],["type","email","autocomplete","off","placeholder","correo@ejemplo.com",1,"w-full","px-4","py-2","border","border-gray-200","rounded-lg","focus:ring-2","focus:ring-primary/20","focus:border-primary","outline-none","transition-all","pl-12","disabled:bg-gray-50","disabled:text-gray-500","disabled:cursor-not-allowed",3,"ngModelChange","ngModel","disabled"],["class","text-[10px] text-gray-400 mt-1 italic",4,"ngIf"],[1,"hidden"],[1,"px-6","py-4","border-t","border-gray-100","flex","justify-end","gap-3","bg-gray-50","rounded-b-2xl","flex-shrink-0"],[1,"px-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","hover:bg-gray-50","transition-all","font-medium",3,"click"],[1,"px-4","py-2","bg-primary","text-white","rounded-lg","hover:bg-primary/90","transition-all","font-medium","disabled:opacity-50","disabled:cursor-not-allowed","shadow-sm","shadow-primary/20",3,"click","disabled"],[1,"bg-blue-50","text-blue-700","p-3","rounded-lg","flex","gap-3","text-sm","items-start"],[1,"w-5","h-5","flex-shrink-0","mt-0.5",3,"img"],[1,"font-bold","block"],[1,"text-[10px]","text-gray-400","mt-1","italic"]],template:function(t,i){t&1&&(o(0,"div",1)(1,"div",2)(2,"div")(3,"h1",3),c(4,"Gesti\xF3n de Usuarios"),s(),o(5,"p",4),c(6,"Administra el acceso y roles del sistema"),s()(),o(7,"button",5),u("click",function(){return i.openModal()}),p(8,"lucide-icon",6),c(9," Nuevo Usuario "),s()(),o(10,"div",7)(11,"div",8),p(12,"lucide-icon",9),o(13,"input",10),E("ngModelChange",function(n){return w(i.searchTerm,n)||(i.searchTerm=n),n}),s()(),o(14,"select",11),u("ngModelChange",function(n){return i.filterByStatus(n)}),o(15,"option",12),c(16,"Todos los estados"),s(),o(17,"option",13),c(18,"Activos"),s(),o(19,"option",14),c(20,"Inactivos"),s()(),o(21,"select",15),u("ngModelChange",function(n){return i.filterByRole(n)}),o(22,"option",12),c(23,"Todos los roles"),s(),o(24,"option",16),c(25,"Administradores"),s(),o(26,"option",17),c(27,"Especialistas"),s()()(),o(28,"div",18)(29,"table",19)(30,"thead",20)(31,"tr")(32,"th",21),c(33,"Usuario "),s(),o(34,"th",21),c(35,"Rol "),s(),o(36,"th",21),c(37,"Estado "),s(),o(38,"th",22),c(39," Acciones"),s()()(),o(40,"tbody",23),b(41,we,27,16,"tr",24),s()()()(),b(42,Ie,28,11,"div",25)),t&2&&(l(8),d("img",i.Icons.Plus),l(4),d("img",i.Icons.Search),l(),C("ngModel",i.searchTerm),l(),d("ngModel",i.selectedStatus()),l(7),d("ngModel",i.selectedRole()),l(20),d("ngForOf",i.filteredUsers()),l(),d("ngIf",i.isModalOpen))},dependencies:[q,j,B,W,he,ge,fe,ce,ue,pe,me,le,se],encapsulation:2})};export{xe as UsersListComponent};
