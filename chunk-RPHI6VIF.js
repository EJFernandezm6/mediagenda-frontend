import{a as p}from"./chunk-MZ3EZVY4.js";import{L as c,N as a,R as I,W as v,a as m,b as D,f as u,ia as $,r as g,x as n,xc as y}from"./chunk-2ZD6ZATD.js";var b=class d{http=v(y);apiUrl=`${p.apiUrl}/iam/users`;rolesUrl=`${p.apiUrl}/iam/roles`;doctorsUrl=`${p.apiUrl}/catalog/doctors`;doctors=$([]);constructor(){this.refreshDoctors()}refreshDoctors(){n({users:this.http.get(`${this.apiUrl}?role=DOCTOR`),profiles:this.http.get(this.doctorsUrl)}).pipe(g(({users:t,profiles:r})=>(console.log("\u{1F50D} Refreshing Doctors - Raw Users:",t),t.filter(o=>!o.roles.some(i=>i.toUpperCase()==="ADMIN")).map(o=>{let i=r.find(l=>l.userId===(o.userId||o.id));return D(m({},o),{id:o.userId||o.id,doctorId:i?.doctorId,userId:o.userId||o.id,cmp:i?.cmp||"",dni:o.dni||i?.dni||"",rating:i?.rating||0,reviewsCount:i?.reviewsCount||0,active:o.active??i?.isActive??!1})})))).subscribe({next:t=>this.doctors.set(t),error:t=>console.error("Error fetching doctors:",t)})}getAllDoctorsRaw(){return n({users:this.http.get(`${this.apiUrl}?role=DOCTOR`),profiles:this.http.get(this.doctorsUrl)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(g(r=>{let e=r.find(o=>o.roleKey==="DOCTOR"||o.name.toUpperCase()==="DOCTOR");if(!e)throw new Error("Role DOCTOR not found");return e.roleId}),c(r=>{let e={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleId:r,photoUrl:t.photoUrl};return this.http.post(this.apiUrl,e)}),c(r=>{let e={userId:r.userId||r.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,e)}),c(r=>this.http.patch(`${this.doctorsUrl}/${r.doctorId}/status`,{isActive:!0})),a(()=>this.refreshDoctors()))}updateDoctor(t,r){let e=m({},r);delete e.id,delete e.userId,delete e.cmp,delete e.rating,delete e.reviewsCount,delete e.active,delete e.roles,delete e.doctorId;let o=this.doctors().find(s=>s.id===t);o&&(e.fullName||(e.fullName=o.fullName),e.email||(e.email=o.email),e.phone||(e.phone=o.phone),e.roleId||(e.roleId=o.roleId));let i=this.http.put(`${this.apiUrl}/${t}`,e),l=new u(s=>{s.next(null),s.complete()});r.active!==void 0&&(l=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:r.active}));let U=new u(s=>{s.next(null),s.complete()}),h=r.doctorId||this.doctors().find(s=>s.id===t)?.doctorId;if(h){let s=[];(r.cmp!==void 0||r.dni!==void 0)&&s.push(this.http.put(`${this.doctorsUrl}/${h}`,{cmp:r.cmp||this.doctors().find(f=>f.id===t)?.cmp,dni:r.dni||this.doctors().find(f=>f.id===t)?.dni})),r.active!==void 0&&s.push(this.http.patch(`${this.doctorsUrl}/${h}/status`,{isActive:r.active})),s.length>0&&(U=n(s))}return n([i,l,U]).pipe(a(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(a(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let r=t.filter(i=>i.score>=9).length,e=t.filter(i=>i.score<=6).length,o=(r-e)/t.length*100;return Math.round(o)}isProfileComplete(t){return!!(t.fullName&&t.cmp&&t.dni&&t.phone&&t.email)}static \u0275fac=function(r){return new(r||d)};static \u0275prov=I({token:d,factory:d.\u0275fac,providedIn:"root"})};export{b as a};
