import{a as g}from"./chunk-MZ3EZVY4.js";import{Dc as U,Ec as I,L as m,N as f,R as $,W as y,a as p,b as h,f as d,ia as u,r as v,x as D}from"./chunk-2BMW4ZRB.js";var w=class b{http=y(I);apiUrl=`${g.apiUrl}/iam/users`;rolesUrl=`${g.apiUrl}/iam/roles`;doctorsUrl=`${g.apiUrl}/catalog/doctors`;doctors=u([]);totalElements=u(0);selectableDoctors=u([]);constructor(){this.refreshDoctors(0,10,""),this.refreshSelectableDoctors()}refreshDoctors(t=0,r=10,e="",n=!1){let s=new U().set("page",t.toString()).set("size",r.toString());e&&(s=s.set("search",e)),n||(s=s.set("isActive","true")),this.http.get(`${this.doctorsUrl}/with-users`,{params:s}).subscribe({next:l=>{let c=l.content.map(i=>h(p({},i),{id:i.userId,active:i.isActive}));n||(c=c.filter(i=>i.active)),this.doctors.set(c),this.totalElements.set(l.totalElements)},error:l=>console.error("Error fetching doctors:",l)})}getAllDoctorsForValidation(){let t=new U().set("page","0").set("size","10000");return this.http.get(`${this.doctorsUrl}/with-users`,{params:t}).pipe(v(r=>r.content.map(e=>h(p({},e),{id:e.userId,active:e.isActive}))))}refreshSelectableDoctors(){this.http.get(`${this.doctorsUrl}/selectable`).subscribe({next:t=>{this.selectableDoctors.set(t.map(r=>h(p({},r),{id:r.userId||r.id,active:r.isActive??r.active})))},error:t=>console.error("Error fetching selectable doctors:",t)})}getDoctors(){return this.doctors()}addDoctor(t){return this.http.get(this.rolesUrl).pipe(v(r=>{let e=r.find(n=>n.roleKey.toUpperCase()==="DOCTOR");if(!e)throw new Error("Role DOCTOR not found");return e.roleId}),m(r=>{let e={fullName:t.fullName,email:t.email,phone:t.phone,dni:t.dni,password:t.password||"12345678",roleIds:[r],photoUrl:t.photoUrl};return this.http.post(this.apiUrl,e)}),m(r=>{let e={userId:r.userId||r.id,cmp:t.cmp,dni:t.dni};return this.http.post(this.doctorsUrl,e)}),m(r=>this.http.patch(`${this.doctorsUrl}/${r.doctorId}/status`,{isActive:!0})),f(()=>this.refreshDoctors()))}updateDoctor(t,r){let e=p({},r);delete e.id,delete e.userId,delete e.cmp,delete e.rating,delete e.reviewsCount,delete e.active,delete e.roles,delete e.doctorId;let n=Object.keys(e).length>0,s=new d(o=>{o.next(null),o.complete()});if(n){let o=this.doctors().find(a=>a.id===t);o&&(e.fullName||(e.fullName=o.fullName),e.email||(e.email=o.email),e.phone||(e.phone=o.phone),e.roleIds||(e.roleIds=o.roleIds??[])),s=this.http.put(`${this.apiUrl}/${t}`,e)}let l=new d(o=>{o.next(null),o.complete()});r.active!==void 0&&(l=this.http.patch(`${this.apiUrl}/${t}/status`,{isActive:r.active}));let c=new d(o=>{o.next(null),o.complete()}),i=r.doctorId||this.doctors().find(o=>o.id===t)?.doctorId;if(i){let o=[];(r.cmp!==void 0||r.dni!==void 0)&&o.push(this.http.put(`${this.doctorsUrl}/${i}`,{cmp:r.cmp||this.doctors().find(a=>a.id===t)?.cmp,dni:r.dni||this.doctors().find(a=>a.id===t)?.dni})),r.active!==void 0&&o.push(this.http.patch(`${this.doctorsUrl}/${i}/status`,{isActive:r.active})),o.length>0&&(c=D(o))}return D([s,l,c]).pipe(f(()=>this.refreshDoctors()))}deleteDoctor(t){return this.http.delete(`${this.apiUrl}/${t}`).pipe(f(()=>this.refreshDoctors()))}getDoctorReviews(t){return this.http.get(`${this.doctorsUrl}/${t}/reviews`)}calculateNPS(t){if(!t||t.length===0)return 0;let r=t.filter(s=>s.score>=9).length,e=t.filter(s=>s.score<=6).length,n=(r-e)/t.length*100;return Math.round(n)}isProfileComplete(t){return!!(t.fullName&&t.cmp&&t.dni&&t.phone&&t.email)}static \u0275fac=function(r){return new(r||b)};static \u0275prov=$({token:b,factory:b.\u0275fac,providedIn:"root"})};export{w as a};
